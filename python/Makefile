# Makefile for GeneWeb Python Implementation
# ===========================================

.PHONY: help install test test-unit test-integration test-compatibility test-hybrid clean dev-setup

# Variables
PYTHON := python
PYTEST := pytest
SCRIPTS_DIR := scripts
TEST_DIR := tests
REPORTS_DIR := $(TEST_DIR)/reports

# Colors for display
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
RED := \033[31m
NC := \033[0m # No Color

.DEFAULT_GOAL := help

help: ## Show this help
	@echo "$(BLUE)ğŸ§ª GeneWeb Python - Available Commands$(NC)"
	@echo "=============================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

install: ## Install Python consang package
	@echo "$(YELLOW)ğŸ“¦ Installing Python consang package...$(NC)"
	pip install -e .
	@echo "$(GREEN)âœ… Installation completed!$(NC)"

dev-setup: ## Setup development environment
	@echo "$(YELLOW)ğŸ”§ Setting up development environment...$(NC)"
	@$(MAKE) install
	pip install pytest pytest-cov pytest-html PyYAML
	@echo "$(GREEN)âœ… Development environment ready!$(NC)"

test-unit: ## Run Python unit tests
	@echo "$(YELLOW)ğŸ§ª Running unit tests...$(NC)"
	$(PYTEST) $(TEST_DIR)/unit/python/ -v --tb=short
	@echo "$(GREEN)âœ… Unit tests completed!$(NC)"

test-integration: ## Run Python integration tests
	@echo "$(YELLOW)ğŸ”— Running integration tests...$(NC)"
	$(PYTEST) $(TEST_DIR)/integration/ -v --tb=short
	@echo "$(GREEN)âœ… Integration tests completed!$(NC)"

test-compatibility: ## Run OCaml vs Python compatibility tests
	@echo "$(YELLOW)âš–ï¸  Running compatibility tests...$(NC)"
	@chmod +x $(SCRIPTS_DIR)/run_compatibility_tests.sh
	@$(SCRIPTS_DIR)/run_compatibility_tests.sh
	@echo "$(GREEN)âœ… Compatibility tests completed!$(NC)"

test-hybrid: ## Run complete hybrid test suite
	@echo "$(YELLOW)ğŸš€ Running complete hybrid suite...$(NC)"
	@chmod +x $(SCRIPTS_DIR)/run_hybrid_tests.sh
	@$(SCRIPTS_DIR)/run_hybrid_tests.sh
	@echo "$(GREEN)âœ… Hybrid suite completed!$(NC)"

test-all: ## Run all Python tests
	@echo "$(BLUE)ğŸ¯ Running all Python tests...$(NC)"
	@$(MAKE) test-unit
	@$(MAKE) test-integration
	@$(MAKE) test-compatibility

test: test-all ## Alias for test-all

clean: ## Clean Python build artifacts
	@echo "$(YELLOW)ğŸ§¹ Cleaning Python artifacts...$(NC)"
	@find . -name "*.pyc" -delete
	@find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@rm -rf build dist *.egg-info
	@rm -rf $(REPORTS_DIR)
	@echo "$(GREEN)âœ… Cleanup completed!$(NC)"

lint: ## Check Python code style (if flake8 is installed)
	@echo "$(YELLOW)ğŸ” Checking code style...$(NC)"
	@if command -v flake8 >/dev/null 2>&1; then \
		flake8 consang/ --max-line-length=100; \
		echo "$(GREEN)âœ… Style checked!$(NC)"; \
	else \
		echo "$(RED)âš ï¸  flake8 not installed. Install with: pip install flake8$(NC)"; \
	fi

format: ## Format Python code (if black is installed)
	@echo "$(YELLOW)âœ¨ Formatting code...$(NC)"
	@if command -v black >/dev/null 2>&1; then \
		black consang/ --line-length=100; \
		echo "$(GREEN)âœ… Code formatted!$(NC)"; \
	else \
		echo "$(RED)âš ï¸  black not installed. Install with: pip install black$(NC)"; \
	fi

coverage: ## Run tests with code coverage
	@echo "$(YELLOW)ğŸ“Š Running tests with coverage...$(NC)"
	$(PYTEST) $(TEST_DIR)/unit/python/ --cov=consang --cov-report=html:$(REPORTS_DIR)/coverage --cov-report=term
	@echo "$(GREEN)âœ… Coverage report generated in $(REPORTS_DIR)/coverage/$(NC)"

benchmark: ## Run performance tests
	@echo "$(YELLOW)âš¡ Running performance tests...$(NC)"
	$(PYTEST) $(TEST_DIR)/performance/ -v --tb=short
	@echo "$(GREEN)âœ… Performance tests completed!$(NC)"

status: ## Show Python project status
	@echo "$(BLUE)ğŸ“‹ GeneWeb Python Project Status$(NC)"
	@echo "================================="
	@echo "$(YELLOW)Installed package:$(NC)"
	@pip show geneweb-consang 2>/dev/null || echo "  âŒ Not installed"
	@echo "$(YELLOW)Consang binary:$(NC)"
	@which consang 2>/dev/null || echo "  âŒ Not found in PATH"
	@echo "$(YELLOW)Available tests:$(NC)"
	@find $(TEST_DIR) -name "test_*.py" | wc -l | xargs echo "  ğŸ“ Test files:"
	@echo "$(YELLOW)Reports:$(NC)"
	@if [ -d "$(REPORTS_DIR)" ]; then \
		echo "  ğŸ“Š Reports available in $(REPORTS_DIR)/"; \
	else \
		echo "  ğŸ“Š No reports generated"; \
	fi

# Advanced development commands
dev-install: ## Full development installation with dev dependencies
	@echo "$(YELLOW)ğŸ”§ Complete development installation...$(NC)"
	pip install -e ".[dev]"
	pip install pytest pytest-cov pytest-html pytest-benchmark PyYAML black flake8
	@echo "$(GREEN)âœ… Development installation completed!$(NC)"

quick-test: ## Quick tests (unit tests only)
	@echo "$(YELLOW)âš¡ Quick tests...$(NC)"
	$(PYTEST) $(TEST_DIR)/unit/python/ -x -v
	@echo "$(GREEN)âœ… Quick tests completed!$(NC)"

watch: ## Run tests in watch mode (if pytest-watch is installed)
	@echo "$(YELLOW)ğŸ‘€ Watch mode activated...$(NC)"
	@if command -v ptw >/dev/null 2>&1; then \
		ptw $(TEST_DIR)/unit/python/ -- -v; \
	else \
		echo "$(RED)âš ï¸  pytest-watch not installed. Install with: pip install pytest-watch$(NC)"; \
	fi

help-detailed:
	@echo "$(BLUE)ğŸ§ª GeneWeb Python - Complete Guide$(NC)"
	@echo "==================================="
	@echo ""
	@echo "$(YELLOW)ğŸš€ Quick start:$(NC)"
	@echo "  make dev-setup     # Setup environment"
	@echo "  make test-all      # Run all tests"
	@echo ""
	@echo "$(YELLOW)ğŸ§ª Tests:$(NC)"
	@echo "  make test-unit           # Unit tests only"
	@echo "  make test-integration    # Integration tests only"
	@echo "  make test-compatibility  # OCaml vs Python compatibility tests"
	@echo "  make test-hybrid         # Complete suite with reports"
	@echo ""
	@echo "$(YELLOW)ğŸ”§ Development:$(NC)"
	@echo "  make lint          # Style checking"
	@echo "  make format        # Automatic formatting"
	@echo "  make coverage      # Tests with coverage"
	@echo "  make clean         # Cleanup"
	@echo ""
	@echo "$(YELLOW)ğŸ“Š Monitoring:$(NC)"
	@echo "  make status        # Project status"
	@echo "  make benchmark     # Performance tests"
