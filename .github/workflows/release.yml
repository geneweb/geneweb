name: Geneweb Release

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Pre-release'
        required: false
        type: boolean
        default: true
      tag_name:
        description: 'Tag name'
        required: true
        type: string

env:
  DUNE_PROFILE: "release"
  OPAMYES: true

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            ocaml-version: 5.4.0
            platform: macos-arm64
            is-unix: true
          - os: macos-15-intel
            ocaml-version: 5.4.0
            platform: macos-intel
            is-unix: true
          - os: ubuntu-22.04
            ocaml-version: 5.4.0
            platform: linux
            is-unix: true
          - os: windows-latest
            ocaml-version: 4.14.2
            platform: windows
            is-unix: false

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ matrix.ocaml-version }}

      - name: Install Perl dependencies and remove locked mingw gcc shim (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cpan -j .github/ci-config/cpan-config.pm -T -f -i String::ShellQuote IPC::System::Simple;
          rm -f _opam/bin/x86_64-w64-mingw32-gcc.exe || true
          rm -f _opam/bin/i686-w64-mingw32-gcc.exe || true

      - name: Install dependencies
        run: |
          opam install . --deps-only
          ${{ matrix.is-unix && 'opam install ancient' || '' }}

      - name: Force static GMP linking (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          # Zarith is installed with dynamic linking, hide ALL libgmp DLLs
          find /usr -name "libgmp-10.dll" -exec mv {} {}.hidden \; 2>/dev/null || true
          find /usr -name "libgmp.dll.a" -exec mv {} {}.hidden \; 2>/dev/null || true
          OPAM_PREFIX=$(opam var prefix | tr '\\' '/')
          find "$OPAM_PREFIX" -name "libgmp-10.dll" -exec mv {} {}.hidden \; 2>/dev/null || true
          
          # Reinstall zarith WITHOUT depext (won't reinstall system packages)
          echo "Reinstalling zarith with static GMP‚Ä¶"
          OPAMASSUMEDEPEXTS=true opam reinstall zarith --yes
          echo "Static GMP linking configured"

      - name: Configure and build Geneweb
        run: |
          opam exec -- ocaml ./configure.ml --sosa-zarith ${{ matrix.is-unix && '--gwd-caching' || '' }}
          opam exec -- make distrib distrib-rpc

      - name: Bundle PCRE2 runtime DLL (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "=== Bundling PCRE2 DLL for Windows ==="
          OPAM_PATH=$(cygpath "$OPAMROOT")
          PCRE2_DLL=$(find "$OPAM_PATH" /usr/x86_64-w64-mingw32 /usr/bin -name "libpcre2-8-0.dll" 2>/dev/null | head -1)
          
          if [ -n "$PCRE2_DLL" ]; then
            echo "Found: $PCRE2_DLL"
            cp "$PCRE2_DLL" distribution/gw/
            ls -lh distribution/gw/libpcre2-8-0.dll
          else
            echo "ERROR: PCRE2 DLL not found"
            find /usr -name "*pcre2*" 2>/dev/null | head -20
            exit 1
          fi

      - name: Verify static linking (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "=== Checking executable dependencies ==="
          cd distribution/gw
          ldd gwd.exe
          
          NON_WINDOWS=$(ldd gwd.exe | grep -v -F /cygdrive/c/Windows/ || true)
          if [ -n "$NON_WINDOWS" ]; then
            echo "‚ùå ERROR: Non-Windows dependencies found:"
            echo "$NON_WINDOWS"
            exit 1
          else
            echo "‚úÖ SUCCESS: All dependencies are statically linked or from Windows"
          fi

      - name: Minify RPC client with terser
        shell: bash
        working-directory: distribution/gw/etc/js
        run: |
          npm install -g terser
          chmod +w rpc_client.min.js
          terser rpc_client.min.js -o rpc_client.min.js --compress --mangle
          gzip -9 -k -f rpc_client.min.js

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.tag_name }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create macOS bundle and DMG
        if: runner.os == 'macOS'
        shell: bash
        run: |
          echo "üçé Creating macOS bundle and DMG..."
          
          chmod +x create_bundle.sh create_dmg.sh
          
          ./create_bundle.sh
          ./create_dmg.sh
          
          VERSION="${{ steps.version.outputs.version }}"
          ARCH_SUFFIX="${{ matrix.platform == 'macos-arm64' && 'arm64' || 'intel' }}"
          
          # Find and rename the DMG to match tag version (for consistency with ZIP archives)
          CREATED_DMG=$(ls geneweb-*.dmg 2>/dev/null | head -1)
          
          if [ -n "$CREATED_DMG" ]; then
            DMG_NAME="geneweb-${VERSION}-macos-${ARCH_SUFFIX}.dmg"
            mv "$CREATED_DMG" "${DMG_NAME}"
            echo "DMG_NAME=${DMG_NAME}" >> $GITHUB_ENV
            echo "‚úÖ Renamed $CREATED_DMG ‚Üí ${DMG_NAME}"
            ls -lh "${DMG_NAME}"
          else
            echo "‚ö†Ô∏è No DMG found"
            ls -la *.dmg 2>/dev/null || echo "No .dmg files in current directory"
          fi

      - name: Create release archive
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSIONED_ARCHIVE="geneweb-${VERSION}-${{ matrix.platform }}.zip"
          
          cd distribution
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            7z a -tzip "../${VERSIONED_ARCHIVE}" * -mx=9
          else
            zip -9 -r "../${VERSIONED_ARCHIVE}" *
          fi
          cd ..
          
          echo "VERSIONED_ARCHIVE=${VERSIONED_ARCHIVE}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create Windows installer
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          
          # Download InnoSetup
          Write-Host "üì• Downloading InnoSetup..."
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "innosetup-installer.exe"
          
          # Install InnoSetup silently
          Write-Host "üì¶ Installing InnoSetup..."
          Start-Process -FilePath "innosetup-installer.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/DIR=.\innosetup" -Wait
          
          # Compile installer
          Write-Host "üî® Building installer..."
          & ".\innosetup\ISCC.exe" "geneweb.iss" "/DMyVersion=$VERSION"
          
          $INSTALLER_NAME = "geneweb-${VERSION}-windows-setup.exe"
          if (Test-Path $INSTALLER_NAME) {
            Write-Host "‚úÖ Installer created: $INSTALLER_NAME"
            echo "INSTALLER_NAME=$INSTALLER_NAME" >> $env:GITHUB_ENV
          } else {
            Write-Host "‚ùå Installer not found!"
            exit 1
          }

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}
          files: |
            ${{ env.VERSIONED_ARCHIVE }}
            ${{ env.DMG_NAME }}
            ${{ env.INSTALLER_NAME }}
          fail_on_unmatched_files: false
          prerelease: ${{ (github.event_name == 'workflow_dispatch' && inputs.prerelease) || contains(github.ref_name, 'a') || contains(github.ref_name, 'b') || contains(github.ref_name, 'rc') || contains(github.ref_name, 'dev') }}
          draft: false
          name: "GeneWeb ${{ env.VERSION }}"
          body: |
            ${{ contains(env.VERSION, 'alpha') && '‚ö†Ô∏è **Alpha release** - Not for production use' || '' }}
            ${{ contains(env.VERSION, 'beta') && '‚ö†Ô∏è **Beta release** - Testing recommended' || '' }}
            ${{ contains(env.VERSION, 'rc') && '‚úÖ **Release candidate** - Production ready pending final validation' || '' }}
            
            ### Download
            
            | Platform | ZIP Archive | Installer |
            |----------|-------------|-----------|
            | üêß Linux | [geneweb-${{ env.VERSION }}-linux.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}/geneweb-${{ env.VERSION }}-linux.zip) | - |
            | üçé macOS (Apple Silicon) | [geneweb-${{ env.VERSION }}-macos-arm64.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}/geneweb-${{ env.VERSION }}-macos-arm64.zip) | [geneweb-${{ env.VERSION }}-macos-arm64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}/geneweb-${{ env.VERSION }}-macos-arm64.dmg) |
            | üçé macOS (Intel) | [geneweb-${{ env.VERSION }}-macos-intel.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}/geneweb-${{ env.VERSION }}-macos-intel.zip) | [geneweb-${{ env.VERSION }}-macos-intel.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}/geneweb-${{ env.VERSION }}-macos-intel.dmg) |
            | ü™ü Windows | [geneweb-${{ env.VERSION }}-windows.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}/geneweb-${{ env.VERSION }}-windows.zip) | [geneweb-${{ env.VERSION }}-windows-setup.exe](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.event_name == 'workflow_dispatch' && inputs.tag_name || github.ref_name }}/geneweb-${{ env.VERSION }}-windows-setup.exe) |
            
            ### Prerequisites (Unix ZIP archives only)
            
            **Linux:** `sudo apt-get install libgmp10 libpcre2-dev`
            **macOS**, use [Homebrew](https://brew.sh/): `brew install gmp pcre2`
            
            For more information, see the [documentation](https://geneweb.tuxfamily.org/wiki/GeneWeb).
