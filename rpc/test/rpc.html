<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Test RPC client</title>
  </head>
  <body>
    <div>
      <form id="form-ping">
        <label for="input-ping">Enter any text:</label>
        <input type="text-ping" name="input-ping" id="input-ping" required>
      </form>
      <div id="output-ping">waiting...</div>
    </div>
    <div>
      <form id="form-search">
        <label for="input-search">Enter any text:</label>
        <input type="text-search" name="input-search" id="input-search" required>
      </form>
      <ul id="output-search" style="list-style-type: none"></ul>
    </div>
    <script src="../_build/default/bin/rpc-client/main.bc.js"></script>
    <script>
      // TODO : can we write this function in js_of_ocaml?
      function add_method(client, meth) {
        client[meth] = async function (...args) {
          const jargs = args.map((a) => { return JSON.stringify(a); });
          const response = await client.call(meth, jargs);
          console.log(response);
          return JSON.parse(response);
        }
      }

      const client1 = new Rpc("ws://localhost:8080/pingpong");
      add_method(client1, "ping");
      add_method(client1, "echo");


      async function ping_callback() {
        const input = document.getElementById("input-ping");
        const msg = await client1.echo(input.value);
        console.log(msg);
        const output = document.getElementById("output-ping");
        output.innerText = msg;
      }

      document.getElementById("input-ping")
              .addEventListener("input", ping_callback);

      async function main() {
        const msg = await client1.ping();
        console.log(msg);
      }

      const client2 = new Rpc("ws://localhost:8080/search");
      add_method(client2, "lookup");

      async function search_callback() {
        const input = document.getElementById("input-search");
        const msg = await client2.lookup(["test.cache", input.value]);
        const output = document.getElementById("output-search");
        console.log(msg);
        output.innerHTML = "";
        msg.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          output.appendChild(li);
        });
      }

      document.getElementById("input-search")
              .addEventListener("input", search_callback);
    </script>
  </body>
</html>
