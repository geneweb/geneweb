<!-- $Id: perso_module/unions.txt v 7.00 20/11/2016 06:10:01 hg -->
%( op_m=1 simple: name %)
%( op_m=2 evolved: spouse parents and children's spouse %)
%( op_m=3 photos: evolved with spouse photo %)
%( op_m=4 complete: evolved up to grand-children %)
%( op_m=5 photos: complete with photos of spouse and children %)
%let;op_m;%if;(op_m!="")%op_m;%else;1%end;%in;

%define;relations_tree(z1)
    %reset_count;
    href="%prefix;spouse=on;m=RLM;image=%evar.image;;%nn;
    %foreach;witness;
        %incr_count;i%count;=%witness.index;;t%count;=[marriage event];%nn;
        %incr_count;i%count;=z1;%nn;
        %end;
    %incr_count;i%count;=%index;;t%count;=%if;(sex=0)[him/her]0%elseif;(sex=1)[him/her]1%else;0%end;%nn;
    %if;browsing_with_sosa_ref;
        %incr_count;i%count;=%sosa_ref.index;;t%count;=sosa_1;%nn;
    %end;
    " title="[*relations tree]"
%end;

%define;list_witness_of_kind(kindx)
  %reset_count;
  %foreach;event_witness;
  %if;(event_witness_kind = [kindx]0)
    %incr_count;
  %end;
  %end;
  %let;k_cnt;%count;%in;
  %if;(k_cnt>0)
  %if;(k_cnt=1)[*kindx]0%else;[*kindx]1%end;[:]%sp;
  %end;
  %reset_count
  %foreach;event_witness;
  %if;(event_witness_kind = [kindx]0)
    %incr_count;
    %apply;short_display_person("event_witness")
    %if;(count=k_cnt).
    %else;
      %if;(count=k_cnt-1)%sp;[and]%sp;%else;,%sp;%end;
    %end;
  %end;
  %end;
%end;

%(
  Copie des fonctions qui se trouvent dans perso.txt dont la SEULE
  modification est que la phrase NE commence PAS par une majuscule.
%)

%define;loc_married_to(sexx, date)
  %if;(sexx = 0 or sexx = 2)
    %if;are_married;[married%t to:::date]0%nn;
    %elseif;are_not_married;[relationship%t to:::date]0%nn;
    %elseif;are_engaged;[engaged%t to:::date]0%nn;
    %elseif;is_no_sexes_check;[relationship%t to:::date]0%nn;
    %elseif;is_no_mention;date [with]%nn;
    %end;
  %else;
    %if;are_married;[married%t to:::date]1%nn;
    %elseif;are_not_married;[relationship%t to:::date]1%nn;
    %elseif;are_engaged;[engaged%t to:::date]1%nn;
    %elseif;is_no_sexes_check;[relationship%t to:::date]1%nn;
    %elseif;is_no_mention;date [with]%nn;
    %end;
  %end;
%end;

%define;loc_long_married(xx)
  %apply;loc_married_to%with;%xx.sex%and;
    %if;(on_marriage_date = "")
    %else; <em>%on_marriage_date;
      %if;wedding_birthday; ([happy birthday to them!])%end;
      </em>
    %end;
  %end;
%end;

%(
   ATTENTION: on n'utilise pas max_desc_level parce que c'est extremement
   gourmand sur les gros arbre puisqu'on calcule toute la descendance.
   Or on n'a besoin de seulement savoir s'il y a des arrière petits
   enfant, d'où le code ci-dessous :
   1 si on a des enfants
   2 si on a des petits enfants
   3 si on a des arrières petits endants
%)
%reset_count;
%if;has_children;
  %incr_count;
  %foreach;family;
    %foreach;child;
      %foreach;family;
        %if;child.has_children;
          %if;(count<2)
            %incr_count;
          %end;
          %foreach;child;
            %foreach;family;
              %if;child.has_children;
                %if;(count<3)
                  %incr_count;
                %end;
              %end;
            %end;
          %end;
        %end;
      %end;
    %end;
  %end;
%end;

%if;has_families;
  %if;(op_m=1 or op_m=2)
    <h3 class="highlight">[*family/families]0%if;(evar.cgl!="on")<a href="%prefix;%suffix;m=D;t=T;v=2;image=on"><img class="ml-2 treeline" src="%image_prefix;/gui_create.png" height="18" alt="tree desc."/></a>%end;</h3>
  %elseif;(op_m=3)
    <h3 class="highlight">%if(nb_families>1)[*spouse/spouses]1%else;[*spouse/spouses]0%end; %if;nb_children=1)[and::child/children]0%else;[and::child/children]1%end;%nn;</h3>
  %elseif;(op_m=4 or op_m=5)
    <h3 class="highlight">[*marriage/marriages]1%nn;
      %if;(count>0)
        %sp;[and::child/children]1%nn;
        %if;(count>2)
          %sp;[to the great-grandchildren]
        %elseif;(count>1)
          %sp;[to the grandchildren]
        %end;
      %end;
    </h3>
  %end;
%end;

%if;(op_m=1 and has_families)
  <ul class="marriage_perso">
    %( On remet les compteurs à zéro et on commence à compter à 1 - synchro with notes.txt %)
    %reset_count;
    %foreach;family;
      %incr_count;
      %apply;li_SD("spouse")
        %if;(wizard and not cancel_links)
          <a href="%prefix;m=MOD_FAM;i=%family.index;;ip=%index;">
            <img class="ml-0 mr-1 mb-1" src="%image_prefix;/picto_molette.png" width="13" height="13" alt="[modify::family/families]0" title="[modify::family/families]0"%/>%nn;
          </a>%nn;
        %end;
        %apply;long_married("self")%sp;
        %apply;short_display_person("spouse")
        %let;prev_count;%count;%in;
      %(%if;(has_witnesses)
          %sp;([witness/witnesses]w[:]
          %foreach;witness;%(attention witness_kind ne marche pas dans ce contexte !! fwitness non plus %)
            %if;not is_first;, %end;
            %apply;short_display_person("witness")
          %end;
          %if;(evar.cgl!="on")<a %apply;relations_tree(index)><img class="ml-1 treeline" src="%image_prefix;/gui_create.png" height="16" alt="tree"/></a>%nn;
          %end;)%nn;
        %end;%)
        %apply;init_count(prev_count)
        %if;((wizard or friend or bvar.no_note_for_visitor="" or bvar.no_note_for_visitor="no") and has_comment)
          <a class="ml-1" href="#note-wed-%count;" id="wed-callnote-%count;" title="[*see] [note/notes]0 %count"><sup>%count;<sup></a>%nn;
        %end;
        %if;are_divorced;, [divorced]0%divorce_date;%end;
        %if;are_separated;, [separated]0%sp;%end;
        %if;has_children;,%sp;[having as children]0[:]
          %( On sauvegarde l'ancienne valeur de count %)
          %let;prev_count;%count;%in;
          <ul>
            %foreach;child;
              %apply;li_SDC("child")
                %apply;image_MF("child","13")
                %if;(bvar.always_surname="yes")
                  %apply;short_display_person("child")
                %else;
                  %apply;short_display_person_noname("child","","")
                %end;
              </li>
            %end;
          </ul>
          %( On rétablie l'ancienne valeur de count %)
          %apply;init_count(prev_count)
        %end;
        %if;(evar.opt = "from" and wizard)<em>(%origin_file;)</em><br%/>%nl;%end;
      </li>
    %end;
  </ul>

%elseif;(op_m=2 and has_families)
  <ul class="marriage_perso">
    %( On remet les compteurs à zéro et on commence à compter à 1 %)
    %reset_count;
    %foreach;family;
      %incr_count;
      %apply;li_SD("spouse")
        %if;(wizard)
          <a href="%prefix;m=MOD_FAM;i=%family.index;;ip=%index;">
            <img class="mb-1" src="%image_prefix;/picto_molette.png" width="13" height="13" alt="[modify::family/families]0" title="[modify::family/families]0"%/>%nn;
          </a>
        %end;
        %apply;long_married("self")%sp;
        %apply;short_display_person("spouse")
        %if;spouse.has_parents;
          <span style="font-size: 90%%"><em> ([parents][:]
            %apply;short_display_person("spouse.father")
            &nbsp;&amp;&nbsp;
            %apply;short_display_person("spouse.mother"))</em>%nn;
          </span>%nn;
        %end;
        %if;has_witnesses;
          &nbsp;([witness/witnesses]w[:]
          %foreach;witness;
            %if;not is_first;, %end;
            %apply;short_display_person("witness")
          %end;)
        %end;
        %if;((wizard or friend or bvar.no_note_for_visitor="" or bvar.no_note_for_visitor="no") and has_comment)
          <a class="ml-1" href="#note-wed-%count;" id="wed-callnote-%count;" title="[*see] [note/notes]0 %count"><sup>%count;<sup></a>%nn;
        %end;%nn;
        %if;are_divorced;, [divorced]0%divorce_date;%sp;%end;
        %if;are_separated;, [separated]0%sp;%end;
        %if;has_children;%sp;[having as children]0[:]
          %( On sauvegarde l'ancienne valeur de count %)
          %let;prev_count;%count;%in;
          <ul>
            %foreach;child;
              %apply;li_SDC("child")
                %apply;image_MF("child","13")
                %apply;short_display_person("child")
                %if;child.has_families;
                  %foreach;child.family;
                    %if;(family_cnt!=1)
                      <img width="13" height="13"%sp; src="%image_prefix;/1pixel.png" alt="1px"%/>%sp;
                      <em>%child;%child.title;%child.dates;</em>
                    %end;%sp;
                    %sp;%apply;loc_long_married("child")%sp;
                    %apply;short_display_person("spouse")<br%/>
                  %end;
                %end;
              </li>
            %end;
          </ul>
          %( On rétablie l'ancienne valeur de count %)
          %apply;init_count(prev_count)
        %end;
        %if;(evar.opt = "from" and wizard)<em>(%origin_file;)</em><br%/>%nl;%end;
      </li>
    %end;
  </ul>

%elseif;(op_m=3 and has_families)
  %reset_count; %( On remet les compteurs à zéro et on commence à compter à 1 %)
  %foreach;family;
    %incr_count;
    <div class="media">
      %if;spouse.has_image;
        <img class="d-flex col-2 mt-2 ml-2 rounded" src="%spouse.image_url;" alt="[image/images]0" title="%spouse;"%/>
      %else;
        <div class="col-2"></div>
      %end;
      <div class="media-body %if;(spouse.has_image and spouse.has_children)mt-3%else;mt-1%end;">
        <ul class="marriage_perso">
          %apply;li_SD("spouse")
          %if;(wizard)
            <a href="%prefix;m=MOD_FAM;i=%family.index;;ip=%index;">
              <img class="mb-1" src="%image_prefix;/picto_molette.png" width="13" height="13" alt="[modify::family/families]0" title="[modify::family/families]0 [with] %spouse;"%/>%nn;
            </a>
          %end;
          %apply;long_married("self")%sp;
          %apply;short_display_person("spouse")
          %if;((wizard or friend or bvar.no_note_for_visitor="" or bvar.no_note_for_visitor="no") and has_comment)
            <a class="ml-1" href="#note-wed-%count;" id="wed-callnote-%count;" title="[*see] [note/notes]0 %count"><sup>%count;<sup></a>%nn;
          %end;
          %if;(not spouse.has_parents).
          %else;
             %sp;([parents][:]
              <span class="text-nowrap">%apply;short_display_person("spouse.father")</span>%sp;
              <span class="text-nowrap">& %apply;short_display_person("spouse.mother")</span>).%nn;
          %end;
          %if;has_witnesses;
            %sp;[*witness/witnesses]w[:]
            %foreach;witness;
              %if;not is_first;, %end;
              %apply;short_display_person("witness")%nn;
            %end;.
          %end;
          %if;are_divorced;%sp;[*divorced]0%divorce_date;%nn;.%end;
          %if;are_separated;%sp;[*separated]0.%end;
    %if;not has_children;
      </div>
    %else;
      %sp;[*having as children]0[:]
      <ul class="list-unstyled mt-2">
      %let;prev_count;%count;%in; %( On sauvegarde l'ancienne valeur de count %)
      <div class="d-flex flex-wrap">
        %foreach;child;
          <div class="media col-4 my-1 align-selt-center %if;(child.has_image)h-75%else;h-100%end;">
            %if;child.has_image;
              <img class="d-flex mr-3 rounded col-6 align-self-center" src="%child.image_url;" alt="[image/images]0" title="%child;"%/>
            %elseif;(bvar.default_image="yes")
              <img class="d-flex mr-3 rounded col-6 align-self-center" src="%image_prefix;/img_unknown_%if;(is_female)wo%elseif;(is_male)%else;u_%end;man.png" alt="[missing image]"%/>
            %else;
              <img class="d-flex my-5 mr-3 rounded col-6 align-self-center" src="#" alt="[missing image]"%/>
            %end;
            <div class="media-body align-self-center mt-5">
              %apply;li_SDC("child")
                %apply;short_display_person_noname("child","br","age")
              </li>
            </div>
          </div>
        %end;</div>
      </ul>
      %apply;init_count(prev_count) %( On rétablie l'ancienne valeur de count %)
      </div>
    %end;
    %if;(evar.opt = "from" and wizard)<em>(%origin_file;)</em><br%/>%nl;%end;
      </li>
    </ul>
    </div>
  %end;

%elseif;(op_m=4 and has_families)
  <ul class="marriage_perso">
    %( On remet les compteurs à zéro et on commence à compter à 1 %)
    %reset_count;
    %foreach;family;
      %incr_count;
      %apply;li_SD("spouse")
        %if;(wizard)
          <a href="%prefix;m=MOD_FAM;i=%family.index;;ip=%index;">
            <img src="%image_prefix;/picto_molette.png" width="13" height="13" alt="[modify::family/families]0" title="[modify::family/families]0"%/>%nn;
          </a>
        %end;
        %apply;long_married("self")%sp;
        %apply;long_display_person("spouse")
        %if;spouse.has_parents;
          <span style="font-size: 90%%"><em> ([parents][:]
            %apply;image_MF("spouse.father","13")
            %apply;short_display_person("spouse.father")
            &nbsp;&amp;&nbsp;
            %apply;image_MF("spouse.mother","13")
            %apply;short_display_person("spouse.mother"))</em>%nn;
          </span>%nn;
        %end;
        %if;has_witnesses;
          &nbsp;([witness/witnesses]w[:]
          %foreach;witness;
            %if;not is_first;, %end;
            %apply;image_MF("witness","13")
            %apply;short_display_person("witness")
          %end;)
        %end;
        %if;((wizard or friend or bvar.no_note_for_visitor="" or bvar.no_note_for_visitor="no") and has_comment)
          <a class="ml-1" href="#note-wed-%count;" id="wed-callnote-%count;" title="[*see] [note/notes]0 %count"><sup>%count;<sup></a>%nn;
        %end;
        %if;are_divorced;, [divorced]0%divorce_date;%sp;%end;
        %if;are_separated;, [separated]0%sp;%end;
        %if;has_children;%sp;[having as children]0[:]
          %( On sauvegarde l'ancienne valeur de count %)
          %let;prev_count;%count;%in;
          <ul>
            %foreach;child;
              %apply;li_SDC("child")
                %apply;image_MF("child","13")
                %apply;short_display_person("child")
                %if;child.has_families;
                  %foreach;child.family;
                    %if;(family_cnt!=1)
                      <img width="13" height="13" src="%image_prefix;/1pixel.png" alt="1px"/>
                      <em>%child;%child.title;%child.dates;</em>%nn;
                    %end;
                    <em>&nbsp;%apply;loc_long_married("child")</em>
                    %apply;short_display_person("spouse")
                    %if;(nb_children!=0)
                      %sp;[having as children]0[:]
                      <div style="font-size: 90%%">
                        <ul>
                          %foreach;child;
                            %apply;li_SDC("child")
                              %apply;image_MF("child","11")
                              %apply;short_display_person("child")
                              %if;child.has_families;
                                %foreach;child.family;
                                  %if;(family_cnt!=1)
                                    <img width="10" height="10" src="%image_prefix;/1pixel.png"  alt="1px"/>
                                    <em>%child;%child.title;%child.dates;</em>%nn;
                                  %end;
                                  <em>&nbsp;%apply;loc_long_married("child")</em>
                                  %apply;short_display_person("spouse")
                                  %if;(nb_children!=0)
                                    %sp;[having as children]0[:]
                                    <div style="font-size: 90%%">%nn;
                                      <ul>
                                        %foreach;child;
                                          %apply;li_SDC("child")
                                            %apply;image_MF("child","10")
                                            %apply;short_display_person("child")
                                          </li>
                                        %end;
                                      </ul>
                                    </div>
                                  %end;
                                %end;
                              %end;
                            </li>
                          %end;
                        </ul>
                      </div>
                    %else;
                      <br/>
                    %end;
                  %end;
                %end;
              </li>
            %end;
          </ul>
          %( On rétablie l'ancienne valeur de count %)
          %apply;init_count(prev_count)
        %end;
        %if;(evar.opt = "from" and wizard)<em>(%origin_file;)</em><br%/>%nl;%end;
      </li>
    %end;
  </ul>

%elseif;(op_m=5 and has_families)
  <ul>
    %foreach;family;
      %apply;li_SD("spouse")
        %if;spouse.has_image;
          <table style="border-width:%border;">
            <tr>
              <td style="vertical-align: middle">
                 <a href="%spouse.image_html_url;"><img %spouse.image_medium_size;%sp;
                    src="%spouse.image_url;" style="border: none"%sp;
                    alt="" title="[image/images]0"%/></a>
              </td>
              <td style="vertical-align: middle">
        %end;
        %apply;long_married_f("self", "UPPER")%sp;
        %apply;image_MF("spouse","13")
        %apply;display_horizontal("spouse")
        <span style="font-size: 90%%">
          %if;spouse.has_parents;<em> ([parents][:]
            %apply;image_MF("spouse.father","13")
            %apply;short_display_person_f("spouse.father")
            &nbsp;&amp;&nbsp;
            %apply;image_MF("spouse.mother","13")
            %apply;short_display_person_f("spouse.mother"))</em>%nn;
          %end;
        </span>%nn;
        %if;are_divorced;, [divorced]0%divorce_date;%end;
        %if;are_separated;, [separated]0%end;
        %if;spouse.has_image;
              </td>
            </tr>
          </table>
        %end;
        %if;has_children;
          %nl;
          [having as children]0
          <ul>
            %foreach;child;
              %apply;li_SDC("child")
                %if;child.has_image;
                  <table style="border-width:%border;">
                    <tr>
                      <td style="vertical-align: middle">
                        <a href="%child.image_html_url;"><img %child.image_small_size;%sp;
                          src="%child.image_url;" style="border: none"%sp;
                          alt="" title="[image/images]0"%/></a>
                      </td>
                      <td style="vertical-align: middle">
                %end;
                %apply;image_MF("child","13")
                %apply;short_display_person_f("child")
                %if;child.has_families;
                  %foreach;child.family;
                    %if;(family_cnt!=1)
                      <img width="13" height="13"%sp;
                        src="%image_prefix;/1pixel.png" alt="1px" title=""%/>%sp;
                      <em>%child;%child.title;%child.dates;</em>%end;
                    <em>&nbsp;%apply;long_married_f("child", "lower")</em>
                    %apply;image_MF("spouse","13")
                    %apply;short_display_person_f("spouse")%nn;
                    %if;are_divorced; [divorced]0%divorce_date;%end;
                    %if;are_separated; [separated]0%end;
                    %if;(nb_children!=0)
                      &nbsp;[having as children]0
                      %if;(child.has_image and family_cnt=1)</td></tr></table>%end;%nl;
                      <div style="font-size: 90%%">
                        <ul>
                          %foreach;child;
                            %apply;li_SDC("child")
                              %apply;image_MF("child","11")
                              %apply;short_display_person_f("child")
                              %if;child.has_families;
                                %foreach;child.family;
                                  %if;(family_cnt!=1)
                                    <br%/><img width="10" height="10"%sp;
                                            src="%image_prefix;/1pixel.png" alt="1px" title=""%/>
                                    <em>%child;%child.title;%child.dates;</em>%nl;%end;
                                  <em>&nbsp;%apply;long_married_f("child", "lower")</em>
                                  %apply;image_MF("spouse","11")
                                  %apply;short_display_person_f("spouse")
                                  %if;are_divorced; [divorced]0%divorce_date;%end;
                                  %if;are_separated; [separated]0%end;
                                  %if;(nb_children!=0)
                                    &nbsp;[having as children]0[:]
                                    <div style="font-size: 90%%">%nn;
                                      %foreach;child;
                                        %if;(child_cnt!=1) , %end;
                                          %apply;image_MF("child","10")
                                          %apply;short_display_person_f("child")
                                      %end;
                                    </div>
                                  %end;
                                %end;
                              %end;
                            </li>
                          %end;
                        </ul>
                      </div>
                    %else;
                      %if;(child.has_image and family_cnt=1)
                        </td></tr></table>
                      %else;<br%/>%nl;%end;
                    %end;
                  %end;
                %else;
                  %if;child.has_image;</td></tr></table>%nl;%end;
                %end;
              </li>
            %end;
          </ul>
        %end;
        %if;(evar_opt="from" and wizard)<em>(%origin_file;)</em><br%/>%nl;%end;
      </li>
    %end;
  </ul>
%end;

