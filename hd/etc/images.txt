<!DOCTYPE html>
<html lang="%lang;">
<head>
  <!-- $Id: images.txt, v7.00-exp 07/12/2018 01:23:51 hg a2 $ -->
  <!-- Copyright (c) 1998-2019 INRIA -->
  <title>[*add]/[delete::image/images]0 #%index;</title>
  <meta name="robots" content="none">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="%image_prefix;/favicon_gwd.png">
  %include.css;
  %base_header;
</head>
<body%body_prop; id="person">
<div class="container">
%message_to_wizard;
%include_perso_header;
%( Logic for variables:
  file_name must be defined
  mode="comment" then only the comment file is updated
  keydir is “on” if we are dealing with “others” images %)
%(%foreach;env_binding;%if;(env.key!="file")%env.key;=%env.val;<br>%end;%end;%)
%define;alert_header()
  %if;(evar.mode="others")
    %if;(evar.em="SND_IMAGE_OK")[*image received]%if;(evar.notes!="") [with comment]%end;
    %elseif;(evar.em="DEL_IMAGE_OK")[*image deleted]%sp;
      %if;(evar.delete!="on")[and] [saved]1%end;
    %elseif;(evar.em="RESET_IMAGE_OK")[*image/images]0 [restored]1%nn;
    %end;
  %else;
    %if;(evar.em="SND_IMAGE_OK")%if;(evar.mode="comment")[*comment updated]%else;[*portrait] [uploaded]0%end;%nn;
    %elseif;(evar.em="DEL_IMAGE_OK")[*portrait] [deleted]0%if;(evar.delete!="on") [and] [saved]0%end;%nn;
    %elseif;(evar.em="RESET_IMAGE_OK")[*portrait] [restored]%nn;
    %end;%nn;
  %end;
%end;
%define;alert_content()
  %if;(evar.mode="others")
    <samp>images/%keydir;%if;(evar.delete="on")/saved%end;/%evar.file_name;</samp>%nn;
  %else;
    %if;(evar.em="SND_IMAGE_OK" or evar.em="RESET_IMAGE_OK")
      <samp>%evar.file_name;</samp> %if;(evar.em="RESET IMAGE_OK")%portrait; <%end;> <samp>portraits/%portrait;%nn;
      %(%if;(evar.em="DEL IMAGE_OK" or evar.em="RESET_IMAGE_OK")%portrait;%else;%evar.file_name;%end;</samp>%)
    %elseif;(evar.em="DEL_IMAGE_OK")
      <samp>%if;(evar.delete!="on")portrait/%portrait_saved;</samp>%sep;<samp>portrait/saved/%portrait_saved;
            %else;portrait/old/%keydir;.img %portrait_saved; on n'a plus %%portrait_saved; si supprimé !%end;</samp>
    %end;
  %end;
%end;
%define;alert_color()
  %if;(evar.mode="comment")primary
  %elseif;(evar.em="SND_IMAGE_OK" or evar.em="RESET_IMAGE_OK")success
  %elseif;(evar.em="DEL_IMAGE_OK" and evar.delete="on")danger
  %else;warning
  %end;
%end;
%( *** Notification toast *** %)
%if;(evar.em!="")
<div class="bg-light">
  <div class="toast" role="alert" aria-live="assertive" aria-atomic="true"%( data-animation="true"data-autohide="false"%) data-delay="3500"%sp;
    style="position: absolute; top: 0; right: 60px;">
    <div class="toast-header alert-success alert-%apply;alert_color()">
      <strong class="mr-auto">%apply;alert_header()</strong>
      <small>(\o/)</small>
      <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="toast-body text-truncate col-12">
      %apply;alert_content()
    </div>
  </div>
</div>
%end;
%if;(wizard)
  <div class="row">
    %( *** Col 1 *** %)
    <div class="col-6 border border-bottom-0 border-top-0 border-left-0">
      <h1 class="display-4">
        %(<i class="fa fa-portrait fa-fw mr-1"></i>%)
        %if;(has_image)[*modify picture]%else;[*add picture]%end;</h1>
      <form class="form-row" method="post" action="%action;" enctype="multipart/form-data">
        <input type="hidden" name="m" value="SND_IMAGE_OK">
        <input type="hidden" name="i" value="%index;">
        <input type="hidden" name="notes" value="">
        <input type="hidden" name="digest" value=%digest;>
        <div class="custom-file col">
          <input type="file" name="file"
            class="custom-file-input custom-portrait"
            id="portrait_file" accept="image/*" lang="%lang;">
          <label class="custom-file-label text-truncate"
            for="portrait_file">[*select] [image/images]0</label>
        </div>
        <button class="btn btn-primary ml-2 col-2 snd-btn-portrait"
          type="submit" disabled>[*send]</button>
      </form>
      <div class="small mt-2">%nn;
        %if;(has_image)[*save portrait]
          %if;(has_old_image)<br>[*previous portrait]%end;
        %end;
      </div>
      <h1 class="display-4">
      %(<i class="far fa-file-image fa-fw mr-1"></i>%)[*add] [image/images]0</h1>
      <form class="form-row" method="post" action="%action;" enctype="multipart/form-data">
        <input type="hidden" name="m" value="SND_IMAGE_OK">
        <input type="hidden" name="i" value="%index;">
        <input type="hidden" name="mode" id="mode_2" value="others">
        <input type="hidden" name="digest" value=%digest;>
        %( file_name is automatically provided by the type="file" item %)
        %( file_name_2 is used when updating the comment file after selection %)
        %( with the radiobutton of the old folder content (right column) %)
        <input type="hidden" name="file_name_2" id="file_name_2" value="">
        <div class="custom-file col">
          <input type="file" name="file" class="custom-file-input custom-others"%sp;
            id="others_file" accept="image/*" lang="%lang;" autofocus%( multiple%)>
          <label class="custom-file-label text-truncate" for="others_file">%nn;
            [*select] [image/images]0%nn;
          </label>
        </div>
        <button class="btn btn-primary ml-2 col-2 snd-btn-others"
          type="submit" disabled>[*send]
        </button>
        %(TODO: print only if old img already exists%)
        <div class="small col-12 mt-1">[*save image]%sep;%keydir;%sep;saved ></samp>.<br>[*previous image]</div>
        <div class="d-flex col">
          <h1 class="display-4">
            %(<i class="far fa-file-image fa-fw mr-1"></i>%)[*comment]</h1>
          <span class="mb-1 ml-auto align-self-end">%include.toolbar;</span>
        </div>
        <textarea class="form-control col-12" id="notes_comments"
          name="notes" rows="5" placeholder="[*image comment]" disabled>
        </textarea>
        <button class="btn btn-primary mt-2 col-12 btn-update-comment"
          type="submit" disabled>
          <span id="which_img_show">[*send image with comment]</span></button>
      </form>
      %if;(evar.confirm!="")%evar.confirm;%else;&nbsp;%end;
    </div>
    %( *** Col 2 *** %)
    <div class="col-6">
      %if;(has_image or has_old_image)
        <h1 class="display-4">[*portrait]0</h1>
        <i class="fa fa-folder-open fa-lg text-warning mx-2" aria-hidden="true"></i>
        <strong><samp class="text-truncate" title="%base.name;.gwb%sep;documents%sep;portraits%sep;">portraits%sep;</samp></strong>
        %if;has_image;
          <div class="d-flex w-100 mt-1">
            <a role="button" href="%prefix_base_password;&m=IM&i=%index;" target="_blank" rel="noopener"%sp;
              title="[*see] [portrait] %portrait;">
              <i class="far fa-file-image fa-fw text-primary"></i>
            </a>
            <samp class="ml-4" title="%base.name;.gwb%sep;documents%sep;portraits%sep;%portrait;">%portrait;</samp>
            <a role="button" href="%prefix_base_password;&m=DEL_IMAGE_OK&i=%index;&digest=%digest;"
              class="ml-auto col-1" title="[*delete] [and] [save] [portrait]"><i class="far fa-trash-alt text-warning"></i>%nn;
            </a>
          </div>
        %end;
        %if;has_old_image;
          <div class="d-flex w-100%if;(has_image) mt-1%end;">
            <a role="button" href="%prefix_base_password;&m=IMS&i=%index;"
                 target="_blank" rel="noopener" title="[*see] [portrait] %portrait_saved; ([saved images]0)">%nn;
               <i class="far fa-file-image fa-fw text-primary"></i></a>%nn;
            <a role="button" href="%prefix_base_password;&m=RESET_IMAGE_OK&i=%index;&digest=%digest;"
                title="[*restore] [portrait] %portrait_saved; ([saved images]0)">
              <i class="fas fa-retweet fa-rotate-90 fa-fw text-success"></i></a>
            <samp class="ml-1" title="%base.name;.gwb%sep;documents%sep;portraits%sep;saved%sep;%portrait_saved;"><strong>saved ></strong> %portrait_saved;</samp>
            <a role="button" class="ml-auto col-1" href="%prefix_base_password;&m=DEL_IMAGE_OK&i=%index;&digest=%digest;&delete=on"
              title="[*delete] [portrait] ([saved images]0)"><i class="far fa-trash-alt text-danger"></i></a>
          </div>
        %end;
      %end;
      %if;(keydir_img_nbr>0)
        <h1 class="display-4">[*image/images]1</h1>
        %if;(keydir_img_nbr>0)
          <div class="d-flex align-items-center w-100">
            <i class="fa fa-folder-open fa-lg text-warning mx-2" aria-hidden="true"></i>
            <strong><samp class="text-truncate" title="%base.name;.gwb%sep;documents%sep;images%sep;%keydir;">images%sep;%keydir;%sep;</samp></strong>
            <div class="ml-auto">(%keydir_img_nbr; %if;(keydir_img_nbr>1)[image/images]1%else;[image/images]0%end;)</div>
          </div>
          %foreach;img_in_keydir;
            <div class="d-flex w-100 mt-1">
              <a role="button" href="%prefix_base_password;&m=IM&i=%index;&s=%keydir_img_key;"
                target="_blank" rel="noopener" title="[*see] %keydir_img;">%nn;
                <i class="far fa-file-image fa-fw text-primary"></i>%nn;
              </a>
              <a id="notes_%cnt;" href="#"
                class="text-%if;(keydir_img_notes="")danger%else;primary%end;"
                onclick='get_notes(%cnt;, "%keydir_img;"); return false;' %nn;
                data-toggle="tooltip" data-html="true"
                %(data-trigger="focus"%) data-placement="left"
                data-content="%keydir_img_notes;"
                title="<em>[*modify] [comment]</em>%keydir_img_notes;
                %(%if;(keydir_img_title!="")%keydir_img_title;%end;%nn;
                %if;(keydir_img_src!="") <small>(%keydir_img_src;)</small>%end;%)
                "><i class="far fa-file-alt fa-fw"></i>
              </a>
              <samp class="text-truncate ml-1" title="%base.name;.gwd%sep;documents%sep;images%sep;%keydir;%sep;%keydir_img;">%keydir_img;</samp>
              <div class="ml-auto col-1">
                <a role="button" href="%prefix_base_password;&m=DEL_IMAGE_OK&i=%index;&file_name=%keydir_img_key;&mode=others&digest=%digest;"
                  title="[*delete] [and] [save] %keydir_img;">%nn;
                  <i class="far fa-trash-alt text-warning"></i></a>%nn;
              </div>
            </div>
          %end;
        %end;
      %end;
      %if;(keydir_old_img_nbr>0)
        <h1 class="display-4">[*saved images]1</h1>
        <div class="d-flex align-items-center w-100">
          <i class="fa fa-folder-open fa-lg text-warning mx-2" aria-hidden="true"></i>
          <strong><samp class="text-truncate" title="%base.name;.gwb%sep;documents%sep;images%sep;%keydir;%sep;saved%sep;">images%sep;%keydir;%sep;saved%sep;</samp></strong>
          <div class="ml-auto">(%keydir_old_img_nbr; %if;(keydir_old_img_nbr>1)[image/images]1%else;[image/images]0%end;)</div>
        </div>
        %foreach;img_in_keydir_old;
          <div class="d-flex w-100 mt-1">
            <a role="button" href="%prefix_base_password;&m=IMS&i=%index;&s=%keydir_img_old_key;"
               target="_blank" rel="noopener" title="[*see] [saved images]0 %keydir_img_old;">%nn;
              <i class="far fa-file-image fa-fw text-primary"></i></a>%nn;
            <a role="button" href="%prefix_base_password;&m=RESET_IMAGE_OK&i=%index;&mode=others&file_name=%keydir_img_old_key;&digest=%digest;"
               title="[*restore] [saved images]0 %keydir_img_old;">%nn;
              <i class="fa fa-retweet fa-rotate-90 fa-fw text-success"></i></a>%nn;
            <samp class="text-truncate ml-1" title="%base.name;.gwd%sep;documents%sep;images%sep;%keydir;%sep;saved%sep;%keydir_img_old;">%keydir_img_old;</samp>
            <div class="ml-auto col-1">
              <a role="button" href="%prefix_base_password;&m=DEL_IMAGE_OK&i=%index%nn;
                &digest=%digest;&file_name=%keydir_img_old_key;&mode=others%nn;
                &delete=on" title="[*delete] [saved images]0 %keydir_img_old;">%nn;
                <i class="far fa-trash-alt text-danger fa-fw text-primary"></i></a>%nn;
            </div>
          </div>
        %end;
      %end;
    </div>
  </div>
  %if;(evar.em!="")
    <div role="alert" class="alert alert-dismissible fade show alert-%apply;alert_color() mt-2">
      <strong>%apply;alert_header()[:]</strong> %apply;alert_content()
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  %end;
%end;
%base_trailer;
%include.copyr;
</div>
%include.js;
%define;input_snd(xxx,yyy)
$('.xxx').change(function() {
   %(replace input label with file name, then enable send button if input is non empty%)
   let fileName = $(this).val().split('\\').pop();
   $(this).next('.custom-file-label').addClass("selected").html(fileName);
   $('.yyy').attr('disabled', false);
   %if;("yyy"="snd-btn-others")
     $('textarea').attr('disabled', false);
     $('textarea').focus();
   %end;
});
%end;
<script>
%apply;input_snd("custom-portrait","snd-btn-portrait")
%apply;input_snd("custom-others","snd-btn-others")
$('#notes_comments').bind('input propertychange', function() {
  if(this.value.length){
  $('.btn-update-comment').attr('disabled', false);
  }
});
$('.fa-file-alt').click(function() {
  $('.custom-others').attr('disabled', true);
  $('textarea').attr('disabled', false);
  $('textarea').focus();

});
%( Initialize Bootstrap toast, tooltip and popover component, dismiss on next click function,
  TODO: choose one and delete the other %)
$(function () {
  $('.toast').toast()
})
$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})
%($(function () {
  $('[data-toggle="popover"]').popover()
})
$('.popover-dismiss').popover({
  trigger: 'focus'
})%)
$( document).ready(function () {
 $('.toast').toast('show');
})
function get_notes (cnt, name) {
var item = document.getElementById("notes_"+cnt);
document.getElementById("notes_comments").value=item.dataset.content;
document.getElementById("which_img_show").textContent="[*update image comment] "+name;
document.getElementById("file_name_2").value=name;
document.getElementById("mode_2").value="comment";
var ta = document.querySelector('textarea');
autosize.update(ta);
}
</script>
%( Possible heavier futur script to manage multiple files inputs
   https://github.com/Johann-S/bs-custom-file-input/blob/master/dist/bs-custom-file-input.min.js
<script src=%if;(cgi)%bvar.static_path;%end;js/bs-custom-file-input.min.js></script>
<script>$(document).ready(function(){bsCustomFileInput.init()})</script> %)
</body>
</html>
