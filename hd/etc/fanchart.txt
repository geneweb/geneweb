<!DOCTYPE html>
<html lang="%lang;">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="%images_prefix;favicon_gwd.png">
<link rel="apple-touch-icon" href="%images_prefix;favicon_gwd.png">
<title>Arbre en éventail %self; (g%e.v;)</title>
<style title="fc-auto"></style>
<style>
  body { margin: 0; padding: 0; }
  svg { position: absolute; left: 0; top: 0; }
  .hidden { display: none; }
</style>
<link rel="preload" href="%etc_prefix;css/all.min.css?version=6.4.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
<link rel="preload" href="%etc_prefix;css/fanchart.css?version=7.1" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript>
  <link rel="stylesheet" href="%etc_prefix;css/all.min.css?version=6.4.0">
  <link rel="stylesheet" href="%etc_prefix;css/fanchart.css?version=7.1">
</noscript>
</head>
%define;get_random(xxx)
  %random.init;
  %random.xxx;
%end;
%define;dice()
  %random.init;
  %apply;nth%with;one/two/three/four/five/six%and;%random.6;%end;
%end;
%let;random_index;%if;(nb_persons.v!=0)%apply;get_random(nb_persons.v)%end;%in;
%define;somebody_fanchart_info(xx,iii,ccc)
  "%if;("xx"="ancestor")S%xx.anc_sosa.v;%nn;
  %elseif;("xx"="spouse")SPccc%nn;
  %elseif;("xx"="child")CHccc%end;":{"fn":"%if(xx.public_name != "")%xx.public_name;%else;%xx.first_name;%end;","fnk":"%xx.first_name_key","sn":"%xx.surname","snk":"%xx.surname_key;"%if;(xx.occ!=0),"oc":"%xx.occ"%end;,"dates":'%xx.dates;',"birth_place":"%xx.birth_place;","death_place":"%xx.death_place","death_age":"%if;xx.is_dead;%if;xx.computable_death_age;%xx.death_age;%end;%else;%if;xx.computable_age;%xx.age;%end;%end;"%if;("xx"!="child"),"has_parents":%if(xx.has_parents)true%else;false%end;%end;%nn;
  %if;(e.ba = "on" and xx.baptism_place != ""),"baptism_place":"%xx.baptism_place;"%end;
  %if;(e.bu = "on" and xx.burial_place != ""),"burial_place":"%xx.burial_place;"%end;%if;("xx"="ancestor"),"sosa":"%xx.anc_sosa.v;"%end;
  %if;(xx.index!=iii and xx.is_male and "xx"!="spouse")
    %foreach;xx.family;
      %if;(family.index = xx.family.index)
        ,"marriage_date":"%family.date_s;","marriage_place":"%marriage_place;"
        ,"marriage_length":"%nn;
        %if;(family.marriage_date.year!="")
          %if;(not (are_separated or are_divorced))
            %if;(xx.is_dead and xx.death_date.year!="")
              %if;(xx.spouse.is_dead and xx.spouse.death_date.year!="")
                %if;(xx.death_date.year<xx.spouse.death_date.year)
                  %expr(xx.death_date.year-family.marriage_date.year)
                %else;
                  %expr(xx.spouse.death_date.year-family.marriage_date.year)
                %end;
              %else;
                %expr(xx.death_date.year-family.marriage_date.year)
              %end;
            %elseif;(xx.spouse.is_dead and xx.spouse.death_date.year!="")
              %expr(xx.spouse.death_date.year-family.marriage_date.year)
            %elseif;(not xx.is_dead or not xx.spouse.is_dead)
              %expr(today.year-family.marriage_date.year)
            %end;
          %else;
            %if;(family.divorce_date.year!="" and family.divorce_date.year>family.marriage_date.year)
              %expr(family.divorce_date.year-family.marriage_date.year)
            %end;
          %end;
        %end;"
      %end;
    %end;
  %end;},
%end;
%define;somebody_fanchart_same(xx)
"S%xx.anc_sosa.v;":{"fn":"","sn":"%xx.anc_sosa.v › %xx.same","sosasame":"%xx.same;","fnk":"%xx.first_name_key","snk":"%xx.surname_key;","oc":"","dates":"","has_parents":%if;(xx.has_parents)true%else;false%end;},
%end;

<body id="body" class="bg-light p-4"%if;wizard; data-wizard="1"%end;>
<canvas id="pixel" width="1" height="1" style="display: none;"></canvas>
<div id="places-list"><ul id="places_list"></ul></div>
<div id="death-age">
<div><b>[*age]</b><ul>
<li id="DA0"><span class="arrow">▶</span><span class="DA0">■</span>  0-29</li>
<li id="DA1"><span class="arrow">▶</span><span class="DA1">■</span> 30-44</li>
<li id="DA2"><span class="arrow">▶</span><span class="DA2">■</span> 45-59</li>
<li id="DA3"><span class="arrow">▶</span><span class="DA3">■</span> 60-74</li>
<li id="DA4"><span class="arrow">▶</span><span class="DA4">■</span> 75-89</li>
<li id="DA5"><span class="arrow">▶</span><span class="DA5">■</span> 90-104</li>
<li id="DA6"><span class="arrow">▶</span><span class="DA6">■</span> 105+</li>
</ul></div>
<div><b>[*marriage/marriages]0</b><ul>
<li id="DAM0"><span class="arrow">▶</span><span class="DAM0">■</span>  0- 4</li>
<li id="DAM1"><span class="arrow">▶</span><span class="DAM1">■</span>  5-14</li>
<li id="DAM2"><span class="arrow">▶</span><span class="DAM2">■</span> 15-24</li>
<li id="DAM3"><span class="arrow">▶</span><span class="DAM3">■</span> 25-34</li>
<li id="DAM4"><span class="arrow">▶</span><span class="DAM4">■</span> 35-44</li>
<li id="DAM5"><span class="arrow">▶</span><span class="DAM5">■</span> 45-54</li>
<li id="DAM6"><span class="arrow">▶</span><span class="DAM6">■</span> 55+</li>

</ul></div>
</div>
%if;(e.pdf!="on")
<div class="fanchart-controls" id="fanchart-controls">

  <div class="control-section">
    <div class="btn-group-fanchart">
      <button id="b-home" class="btn-fanchart" title="[*home]">
        <i class="fa fa-house fa-fw"></i>
      </button>
      <button id="b-help" class="btn-fanchart" title="Aide et raccourcis">
        <i class="fa fa-info fa-fw"></i>
      </button>
      <button id="b-rng" class="btn-fanchart" title="[*random individual]" data-url="%apply;url_set%with;i/p/n/oc/file/v%and;%random_index;%end;&v=5">
        <i class="fa fa-dice-%apply;dice() fa-fw"></i>
      </button>
    </div>
    <button class="btn-close" id="b-no-buttons" title="[*visualize/show/hide/summary]2">×</button>
  </div>


  <div class="control-section">
    <div class="section-title">[*display]%(TODO%)</div>
    <div class="btn-group-fanchart">
      <button id="b-zoom-out" class="btn-fanchart" title="[*zoom/unzoom]1">
        <i class="fa fa-magnifying-glass-minus fa-fw"></i>
      </button>
      <button id="b-zoom-in" class="btn-fanchart" title="[*zoom/unzoom]0">
        <i class="fa fa-magnifying-glass-plus fa-fw"></i>
      </button>
      <button id="b-refresh" class="btn-fanchart" title="[*resize fanchart]">
        <i class="fa fa-arrow-rotate-right fa-fw"></i>
      </button>
    </div>
  </div>

  <div class="control-section">
    <div class="section-title" id="generation-section-title">[generation/generations]1</div>
    <div class="btn-group-fanchart">
      <button id="b-gen-del" class="btn-fanchart %if;(e.v <= 1)disabled%end;" title="Supprimer une génération">
        <i class="fa fa-minus fa-fw"></i>
      </button>
      <button id="b-gen-add" class="btn-fanchart %if;(e.v >= 10)disabled%end;" title="Ajouter une génération">
        <i class="fa fa-plus fa-fw"></i>
      </button>
      <button id="b-implex" class="btn-fanchart" title="%if;(e.implex="")Développer%else;Réduire%end; les implexes">
        <i class="fa fa-comment-%if;(e.implex="")dots%else;slash%end; fa-fw"></i>
      </button>
    </div>
  </div>

  <div class="control-section">
    <div class="section-title">Ouverture</div>
    <div class="btn-group-fanchart">
      <button id="b-angle-180" class="btn-fanchart" title="Vue en demi-cercle">180</button>
      <button id="b-angle-220" class="btn-fanchart active" title="Vue standard">220</button>
      <button id="b-angle-260" class="btn-fanchart" title="Vue étendue">260</button>
    </div>
  </div>

  <div class="control-section">
    <div class="section-title">Mode</div>
    <div class="btn-group-fanchart">
      <button id="b-circular-mode" class="btn-fanchart" title="Mode circulaire (360°)">
        <i class="fa fa-circle-notch fa-fw"></i>360
      </button>
    </div>
  </div>

  <div class="control-section">
    <div class="section-title">[*font]</div>
    <div class="btn-group-fanchart">
     <select id="font-selector" class="custom-select custom-select-sm mx-0">
       <option value="">Standard</option>
       <option value="mono">Monospace</option>
       <option value="serif">Serif</option>
       <option value="large">Grande</option>
       <option value="readable">Lisible</option>
    </select>
    </div>
  </div>
  <div class="control-section">
    <div class="section-title">[*tools]</div>
    <div class="btn-group-fanchart">
      <button id="b-death-age" class="btn-fanchart"
              title="Âges décès et durées mariage">
        <i class="fa fa-cross fa-fw"></i>
      </button>
       <button id="b-places-colorise" class="btn-fanchart"
        title="Colorisation des lieux (cycle entre les événements)">
        <i class="fa fa-paintbrush fa-fw"></i>
      </button>
      <button id="b-sort-places" class="btn-fanchart"
        title="Trier par ordre alphabétique">
        <i class="fa fa-arrow-down-a-z fa-fw"></i>
      </button>
    </div>

    <!-- Événements NBMDS ultra-compacts -->
    <div class="event-toggles">
      <div class="event-toggle">
        <input type="checkbox" id="bi" title="N">
        <label for="bi">N</label>
      </div>
      <div class="event-toggle" id="bal">
        <input type="checkbox" id="ba" title="B">
        <label for="ba">B</label>
      </div>
      <div class="event-toggle">
        <input type="checkbox" id="ma" title="M">
        <label for="ma">M</label>
      </div>
      <div class="event-toggle">
        <input type="checkbox" id="de" title="D">
        <label for="de">D</label>
      </div>
      <div class="event-toggle" id="bul">
        <input type="checkbox" id="bu" title="S">
        <label for="bu">S</label>
      </div>
    </div>
  </div>
</div>
<div id="fanchart-container" style="position: relative;">
  <svg id="fanchart" class="bi ba ma de bu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>
  <div id="person-panel" class="identity-panel"></div>
</div>
<script>
var link_to_person = "%prefix;";
var max_gen = %e.v;;
var tool = "%e.tool;";
var implexMode = "%e.implex;" === "num" ? "numbered" : 
                 "%e.implex;" === "full" ? "full" : "reduced";
var initial_angle = %if;(e.angle != "")%e.angle;%else;220%end;;
var ancestor = {
%foreach;ancestor_level(e.v)
  %foreach;ancestor;
    %if;(ancestor.same = "")
      %apply;somebody_fanchart_info("ancestor", index, "")
    %else;
      %apply;somebody_fanchart_same("ancestor")
    %end;
  %end;
%end;
};

%reset_count;
var spouses = {
%if;has_families;
  %foreach;family;
    %apply;somebody_fanchart_info("spouse", index, count)
    %incr_count;
  %end;
%end;
};

%reset_count;
var children = {
%if;has_families;
  %foreach;family;
    %if;has_children;
      %foreach;child;
      %apply;somebody_fanchart_info("child", index, count)
      %incr_count;
      %end;
    %end;
  %end;
%end;
};

// Dictionnaire de traductions pour fanchart.js
window.FC_TRANSLATIONS = {
  // Messages généraux
  'no_info_available': '[*no information available]',
  'generation': '[generation/generations]0',
  'generations': '[generation/generations]1',
  'occurrence': '[occurence]0',
  'occurrences': '[occurence]1',
  'place': '[place/places]0',
  'places': '[place/places]1',
  'event': '[event/events]0',
  'events': '[event/events]1',
  'birth': '[birth]0',
  'births': '[birth]1',
  'baptism': '[baptism]0',
  'baptisms': '[baptism]1',
  'marriage': '[marriage/marriages]0',
  'marriages': '[marriage/marriages]1',
  'death': '[death]0',
  'deaths': '[death]1',
  'burial': '[burial]0',
  'burials': '[burial]1',

  // À vérifier…
  'marriage_years': '[*marriage years]',
  'marriage_year': '[*marriage year]',
  'years_old': '[*years old]',

  // Navigation
  'recenter_tree_on': '[*recenter tree on]',
  'no_known_parents': '[*no known parents]',
  'individual_sheet': '[*individual sheet]',
  'navigation_help': '[*navigation help]',
  'ctrl_click_sheet': '[*ctrl click for individual sheet]',

  // Erreurs
  'error_access_sheet': '[*error accessing individual sheet]',

  // Interface
   'sort_by_frequency': '[*sort by frequency]',
  'sort_alphabetically': '[*sort alphabetically]',
};

// Fonction helper pour récupérer une traduction
window.t = function(key, defaultValue = key) {
  const keys = key.split('.');
  let value = window.FC_TRANSLATIONS;

  for (const k of keys) {
    if (value && typeof value === 'object' && k in value) {
      value = value[k];
    } else {
      return defaultValue;
    }
  }

  return typeof value === 'string' ? value : defaultValue;
};
</script>
<script src="%etc_prefix;js/fanchart.js"></script>
</body>
</html>
