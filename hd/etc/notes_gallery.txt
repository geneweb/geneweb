<!DOCTYPE html>
<html>
<head>
  <title>Gallerie</title>
  <meta name="robots" content="none">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="%image_prefix;/favicon_gwd.png">
  <link rel="apple-touch-icon" href="%image_prefix;/favicon_gwd.png">
  %include;css
  <style>
    .in { background-color: coral; }
    .list_comma li { display: inline; }
    .list_comma li:not(:last-child):after { content: ", "; }
    .list_comma li:last-child:after { content: "."; }
  </style>
  %include;hed
</head>
<body%body_prop;>
<div class="container-fluid">
<div class="small float-right mr-4 mt-2">
  (<a href="%url;ref=on">[linked pages]</a>)
</div>
%include;home
<h1 id="h1">Chargement en coursâ€¦</h1>
%if(wizard)
  <div class="small float-right mr-4">
    (<a href="%prefix;m=MOD_NOTES&f=%evar.f;">[modify]</a>)
  </div>
%end;

<div id="description"></div>

<map id="map" name="map"></map>
<img id="image" class="mt-1" usemap="#map" alt=""><!-- no src, managed on javascript side -->
<div class="d-none" id="div_legend">%nn;
  [*on this image][:]%nn; <ul id="legend" class="d-inline list_comma list-unstyled p-0"></ul>
</div>
<div class="d-none" id="div_unknown">%nn;
  [*unknown person][:]%nn; <ul id="unknown" class="d-inline list_comma list-unstyled pl-0"></ul>
</div>

</div>
%include;trl
%include;copyr

</div>
%include;js
<script src="%if(cgi)%bvar.static_path;%end;js/jquery.maphilight.js"></script>
<script>
function get( v ) {
  if( typeof v !== "undefined" ) {
    return v
  } else {
    return ""
  }
}

var doc_path="%prefix;m=DOC&s=";
var public_path="%bvar.gallery_path;";
var private_path="%bvar.gallery_path_private;";
$(document).ready(function() {
  $.ajax( "%url;ajax=on" )
  .done( function( json ) {
    $("#h1").html( json.title );
    $("#description").html( json.desc );
    if( json.path == "doc" ) {
      $("#image").attr( "src", doc_path+json.img );
    } else if( json.path == "private" ) {
      $("#image").attr( "src", private_path+json.img );
    } else if ( json.path == "public" ) {
      $("#image").attr( "src", public_path+json.img );
    } else {
      $("#image").attr( "src", json.path+json.img );
    }

    var cnt = 1;
    json.map.forEach( function( r ) {
      var href = "";
      var txt = get(r.alt);
      if( txt == "") { txt = cnt }

      if( get(r.t) == "" || r.t == "p" ) {
        var oc = get(r.oc);
        if( oc != "" && oc != 0 ) { oc = "&oc=" + oc } else { oc = "" }
        if( get(r.fn) != "" && get(r.sn) != "" ) {
          href = "%prefix;&p=" + r.fn + "&n=" + r.sn + oc;
          txt = r.fn + " " + r.sn;
        }
        if( get(r.alt) != "" ) { txt += " (" + r.alt + ")"; }
        if( get(r.fn) != "" && get(r.sn) != "" ) {
          $("#legend").append( "<li class='legend' id='a" + cnt + "'><span><a href='" + href + "'>" + txt + "</a></span></li>" );
          $("#div_legend").addClass( "d-inline" ).removeClass( "d-none" );
        } else {
          $("#unknown").append( "<li class='legend' id='a" + cnt + "'><span>" + txt + "</span></li>" );
          $("#div_unknown").addClass( "d-inline" ).removeClass( "d-none" );
        }
      } else if( r.t == "m" ) {
        href = "%prefix;m=NOTES&f=" + get(r.misc);
        $("#legend").append( "<li class='legend' id='a" + cnt + "'><span><a href='" + href + "'>" + txt + "</a></span></li>" );
        $("#div_legend").addClass( "d-inline" ).removeClass( "d-none" );
      } else if( r.t == "g" ) {
        href = "%prefix;" + get(r.href);
        $("#legend").append( "<li class='legend' id='a" + cnt + "'><span><a href='" + href + "'>" + txt + "</a></span></li>" );
        $("#div_legend").addClass( "d-inline" ).removeClass( "d-none" );
      } else if( r.t == "e" ) {
        href = get(r.href);
        $("#legend").append( "<li class='legend' id='a" + cnt + "'><span><a href='" + href + "'>" + txt + "</a></span></li>" );
        $("#div_legend").addClass( "d-inline" ).removeClass( "d-none" )
      }
      if( href != "" ) { href = " href='"+ href + "'"; }
      $("#map").append( "<area id='area" + cnt + "' shape='" + get(r.shape) + "' coords='" + get(r.coords) + "' alt='" + txt + "' title='" + txt + "'" + href + ">" );

      cnt++;
    });

    $("#image").maphilight();

    $(".legend").mouseover( function(e) {
      $( "#area" + $(this).attr("id").replace(/[a-z]/g, "") ).mouseover();
    }).mouseout( function(e) {
      $( "#area" + $(this).attr("id").replace(/[a-z]/g, "") ).mouseout();
    });

    $("area").mouseover( function(e) {
      $( "#a" + $(this).attr("id").replace(/[a-z]/g, "") + " span" ).addClass( "in" );
    }).mouseout( function(e) {
      $( "#a" + $(this).attr("id").replace(/[a-z]/g, "") + " span" ).removeClass( "in" );
    });
  })
  .fail( function() {
    $("#h1").text( "Erreur de chargement" );
  })
} );
</script>
</body>
</html>
