<!-- $Id: notes_gallery.txt v7.1 29/12/2025 00:39:49 $ -->
<!DOCTYPE html>
<html>
<head>
  <title>Gallerie</title>
  <meta name="robots" content="none">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="%image_prefix;favicon_gwd.png">
  <link rel="apple-touch-icon" href="%image_prefix;favicon_gwd.png">
  %include;css
  %include;hed
</head>
<body%body_prop;>
<div class="container-fluid">
  %include;home
  <div class="small float-right mr-2 mt-2">
    (<a href="%url;&ref=on"
        title="[pages where page appears]"><-</a>)
  </div>
  <h1 id="h1" class="ml-3 mb-0">Chargement en cours…</h1>
  %if(wizard)
    <div class="small float-right mr-2">
      (<a href="%prefix;m=MOD_NOTES&f=%e.f;">[modify::]</a>)
    </div>
  %end;
  <div id="album-nav" class="d-none justify-content-center">
    <div class="p-2 bd-highlight"><a id="first" href="#" onclick="loadFirstImage(); return false;"><i class="fa-solid fa-backward"></i></a></div>
    <div class="p-2 bd-highlight"><a id="previous" href="#" onclick="loadPreviousImage(); return false;"><i class="fa-solid fa-caret-left"></i></a> </div>
    <div class="p-2 bd-highlight"><a id="current"></a> / <a id="imageCount"></a></div>
    <div class="p-2 bd-highlight"><a id="next" href="#" onclick="loadNextImage(); return false;"><i class="fa-solid fa-caret-right"></i></a></div>
    <div class="p-2 bd-highlight"><a id="last" href="#" onclick="loadLastImage(); return false;"><i class="fa-solid fa-forward"></i></a></div>
  </div>
  <div class="d-inline-flex ml-3">
  <map id="map" name="map"></map>
  <div>
  <img id="image" usemap="#map" alt=""><!-- no src, managed on javascript side -->
  <span id="description" class="ml-3 mt-3"></span>
  </div>
  <div class="d-none ml-3" id="div_legend">%nn;
    [*on this image][:]
    <a id="rlm" href="%prefix;m=RLM" title="[*relations tree]"><img src="%image_prefix;/gui_create.png" height="18" alt="Tree"></a>
    <div id="legend" class="list-comma list-unstyled pl-1"></div>
  </div>

  <div class="d-none" id="div_unknown">%nn;
    [*unknown person][:]%nn; <ul id="unknown" class="d-inline list-comma list-unstyled pl-0"></ul>
  </div>
  <div class="d-none" id="grp_table_container">
    <table id="grp_table" border="1">
      <thead>
        <tr>
          <th>Name</th>
          <th>Label</th>
        </tr>
      </thead>
      <tbody>
        <!-- Group rows will be inserted here -->
      </tbody>
    </table>
  </div>
</div>
%include;trl
%include;copyr

%include;js
%query_time;
%if;(b.use_cdn="yes")
  <script src="https://cdn.jsdelivr.net/npm/maphilight@1.4.2/jquery.maphilight.min.js">
    integrity="sha256-CMISu7vXb6gfvgekngAzo/Mk2GOoFeLy9UIqjtJrt5Y=
               sha384-+gw07sufgVITpP4bHCQQeafUY2NQfyPBM3+931FUWejozbZ0+hCcd8dTUP4epnQK
               sha512-1YiTT24MNHA6DRzyu+w9F5Egc8evYlyEnzSSTD4/M7q42xEb5fSpNgn0+1CPy3evubHs3xdlh8uXgae0DOhR7Q=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
%else;
  <script src="%etc_prefix;js/jquery.maphilight.min.js?version=1.4.2"></script>
%end;
<script>
const MAPHILIGHT_CONFIG = {
  fillColor: 'ff0000',
  fillOpacity: 0.15,
  strokeColor: 'ff0000',
  strokeOpacity: 0.6,
  strokeWidth: 2,
  alwaysOn: false
};

// palette alternant chaud/froid/pastel + bon contraste avec bleu #007bbf (0.3 opacity)
const GROUP_COLORS = %[
  'ff6b6b', // 1. Rouge corail
  'a0c4ff', // 2. Bleu ciel
  'ffd93d', // 3. Jaune doré
  'c7ceea', // 4. Lavande
  'ffaaa5', // 5. Pêche
  '4ecdc4', // 6. Cyan
  'fdcb6e', // 7. Jaune moutarde
  'ff8b94', // 8. Rose
  '74b9ff', // 9. Bleu clair
  'ffc3a0', // 10. Abricot
  'a8e6cf', // 11. Vert menthe
  'ffc6ff', // 12. Rose bonbon
  'b4f8c8', // 13. Vert pastel
  'ff7675', // 14. Rouge doux
  '89e5e5', // 15. Turquoise clair
  'ffeaa7', // 16. Jaune pâle
  'd4a5ff', // 17. Violet pastel
  'fab1a0', // 18. Saumon
  'c7f0db', // 19. Vert d'eau
  'fd79a8', // 20. Rose vif
  'fff3cd', // 21. Crème
  'ffccf9', // 22. Mauve rosé
  'ffe0f0', // 23. Rose poudré
  'ffd9e8'  // 24. Rose très pâle
%];

let current = 0;
let imagesCount = 0;
let json, images_l;
let groupLocked = {};

function get(v) { return v !== undefined ? v : ""; }

function displayImage(img) {
  $("#map, #legend").empty();
  $("#h1").html(json.title);
  $("#description").html(json.desc);
  $("#image").attr("src", "%prefix;m=DOC&s=" + img.img);
  
  let cnt = 1, cnt_rlm = 1;
  const hasGroups = img.groups?.length;
  
  // Structure par groupe
  if (hasGroups) {
    const groupedItems = {};
    
    // Préparer les groupes
    img.groups.forEach(g => {
      groupedItems[g.name] = { label: g.label, items: [] };
    });
    
    // Assigner les items aux groupes
    img.map.forEach(r => {
      if (!r.fn || !r.sn) return;
      
      const oc = get(r.oc) && r.oc != "0" ? `&oc=${r.oc}` : "";
      const href = `%prefix;&p=${r.fn}&n=${r.sn}${oc}`;
      const txt = `${r.fn} ${r.sn}`;
      const comment = get(r.alt) ? ` (${r.alt})` : "";
      const groupNum = r.group || 0;
      
      const item = {
        id: cnt,
        href: href,
        txt: txt,
        comment: comment,
        groupNum: groupNum,
        shape: get(r.shape),
        coords: get(r.coords),
        rlmParams: `&p${cnt_rlm}=${r.fn}&n${cnt_rlm}=${r.sn}${oc}`
      };
      
      if (groupNum && groupedItems[groupNum]) {
        groupedItems[groupNum].items.push(item);
      }
      
      cnt++; cnt_rlm++;
    });
    
    // Générer HTML par groupe
    Object.entries(groupedItems).forEach(([groupNum, group]) => {
      const groupHtml = `
        <div class="imap-group mb-2">
          <div class="imap-group-legend" id="g${groupNum}">
            <a href="#" title="[*lock group]">${group.label}</a>
          </div>
          <ul class="list-comma list-unstyled pl-3">
            ${group.items.map(item => {
              $("#map").append(`<area id='area${item.id}' shape='${item.shape}' coords='${item.coords}' alt='${item.txt}${item.comment}' title='${item.txt}${item.comment}' href='${item.href}' class='group${groupNum}' target='_blank'>`);
              $("#rlm").attr("href", $("#rlm").attr("href") + item.rlmParams);
              
              return `<li class='legend' id='a${item.id}'><span><a href="${item.href}" target='_blank'>${item.txt}</a>${item.comment}</span></li>`;
            }).join('')}
          </ul>
        </div>
      `;
      $("#legend").append(groupHtml);
    });
  } else {
    img.map.forEach(r => {
      if (!r.fn || !r.sn) return;
      
      const oc = get(r.oc) && r.oc != "0" ? `&oc=${r.oc}` : "";
      const href = `%prefix;&p=${r.fn}&n=${r.sn}${oc}`;
      const txt = `${r.fn} ${r.sn}`;
      const comment = get(r.alt) ? ` (${r.alt})` : "";
      
      $("#map").append(`<area id='area${cnt}' shape='${get(r.shape)}' coords='${get(r.coords)}' alt='${txt}${comment}' title='${txt}${comment}' href='${href}' target='_blank'>`);
      $("#legend").append(`<li class='legend' id='a${cnt}'><span><a href="${href}" target='_blank'>${txt}</a>${comment}</span></li>`);
      $("#rlm").attr("href", $("#rlm").attr("href") + `&p${cnt_rlm}=${r.fn}&n${cnt_rlm}=${r.sn}${oc}`);
      
      cnt++; cnt_rlm++;
    });
  }
  
  $("#div_legend").removeClass("d-none");
  $("#image").maphilight(MAPHILIGHT_CONFIG);
}

$(document).on("mouseover", "area", function() {
  const $area = $(this);
  const areaId = $area.attr('id');
  const groupClass = $area.attr('class');

  if (groupClass && groupLocked[groupClass]) {
    const lockedColor = $area.data('locked-color');
    if (lockedColor) {
      $area.data('maphilight', {
        ...MAPHILIGHT_CONFIG,
        alwaysOn: true,
        fillColor: lockedColor,
        fillOpacity: 0.5,
        strokeColor: lockedColor,
        groupBy: false
      }).trigger('alwaysOn.maphilight');

      $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '#' + lockedColor + 'aa');
    }
  } else {
    $area.data('maphilight', { ...MAPHILIGHT_CONFIG, alwaysOn: true, groupBy: false }).trigger('alwaysOn.maphilight');
    $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '#ffccaa');
  }
});

$(document).on("mouseout", "area", function() {
  const $area = $(this);
  const areaId = $area.attr('id');
  const groupClass = $area.attr('class');

  if (groupClass && groupLocked[groupClass]) {
    const lockedColor = $area.data('locked-color');
    if (lockedColor) {
      $area.data('maphilight', {
        ...MAPHILIGHT_CONFIG,
        alwaysOn: true,
        fillColor: lockedColor,
        fillOpacity: 0.2,
        strokeColor: lockedColor,
        groupBy: false
      }).trigger('alwaysOn.maphilight');

      $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '#' + lockedColor + '66');
    }
  } else {
    $area.data('maphilight', MAPHILIGHT_CONFIG).trigger('alwaysOn.maphilight');
    $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '');
  }
});

$(document).on("mouseover", ".legend:not(.imap-group-legend)", function() {
  const areaId = $(this).attr('id').replace('a', 'area');
  const $area = $('#' + areaId);
  const groupClass = $area.attr('class');

  if (groupClass && groupLocked[groupClass]) {
    const lockedColor = $area.data('locked-color');
    if (lockedColor) {
      $area.data('maphilight', {
        ...MAPHILIGHT_CONFIG,
        alwaysOn: true,
        fillColor: lockedColor,
        fillOpacity: 0.5,
        strokeColor: lockedColor,
        groupBy: false
      }).trigger('alwaysOn.maphilight');

      $(this).find('span a').css('background-color', '#' + lockedColor + 'aa');
    }
  } else {
    $(this).find('span a').css('background-color', '#ffccaa');
    $area.data('maphilight', { ...MAPHILIGHT_CONFIG, alwaysOn: true, groupBy: false }).trigger('alwaysOn.maphilight');
  }
});

$(document).on("mouseout", ".legend:not(.imap-group-legend)", function() {
  const areaId = $(this).attr('id').replace('a', 'area');
  const $area = $('#' + areaId);
  const groupClass = $area.attr('class');

  if (groupClass && groupLocked[groupClass]) {
    const lockedColor = $area.data('locked-color');
    if (lockedColor) {
      $area.data('maphilight', {
        ...MAPHILIGHT_CONFIG,
        alwaysOn: true,
        fillColor: lockedColor,
        fillOpacity: 0.2,
        strokeColor: lockedColor,
        groupBy: false
      }).trigger('alwaysOn.maphilight');

      $(this).find('span a').css('background-color', '#' + lockedColor + '66');
    }
  } else {
    $(this).find('span a').css('background-color', '');
    $area.data('maphilight', MAPHILIGHT_CONFIG).trigger('alwaysOn.maphilight');
  }
});

let colorOffset = 0;

$(document).on("mouseover", ".imap-group-legend", function() {
  const groupNum = $(this).attr('id').replace('g', '');
  const groupClass = 'group' + groupNum;
  
  if (groupLocked[groupClass]) return;
  
  $('.' + groupClass).each(function(index) {
    const $area = $(this);
    const areaId = $area.attr('id');
    const color = GROUP_COLORS%[(colorOffset + index) % GROUP_COLORS.length%];
    
    $area.data('maphilight', {
      ...MAPHILIGHT_CONFIG,
      alwaysOn: true,
      fillColor: color,
      strokeColor: color,
      groupBy: false
    }).trigger('alwaysOn.maphilight');
    
    $area.data('locked-color', color);
    $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '#' + color + '66');
  });
});

$(document).on("mouseout", ".imap-group-legend", function() {
  const groupNum = $(this).attr('id').replace('g', '');
  const groupClass = 'group' + groupNum;
  
  if (groupLocked[groupClass]) return;
  
  const groupSize = $('.' + groupClass).length;
  colorOffset += groupSize;
  
  $('.' + groupClass).each(function() {
    const $area = $(this);
    const areaId = $area.attr('id');
    
    $area.removeData('locked-color');
    $area.data('maphilight', MAPHILIGHT_CONFIG).trigger('alwaysOn.maphilight');
    $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '');
  });
});

$(document).on("click", ".imap-group-legend", function(e) {
  e.preventDefault();
  const groupNum = $(this).attr('id').replace('g', '');
  const groupClass = 'group' + groupNum;
  
  if (!groupLocked[groupClass]) {
    Object.keys(groupLocked).forEach(otherGroup => {
      if (groupLocked[otherGroup]) {
        groupLocked[otherGroup] = false;
        $('.imap-group-legend').removeClass('imap-locked');
        
        $('area[class^="group"]').each(function() {
          const areaId = $(this).attr('id');
          $(this).removeData('locked-color');
          $(this).data('maphilight', MAPHILIGHT_CONFIG).trigger('alwaysOn.maphilight');
          $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '');
        });
      }
    });
  }
  
  groupLocked[groupClass] = !groupLocked[groupClass];
  $(this).toggleClass('imap-locked');
  
  if (groupLocked[groupClass]) {
    let needsColors = false;
    $('.' + groupClass).first().each(function() {
      if (!$(this).data('locked-color')) needsColors = true;
    });
    
    if (needsColors) {
      $('.' + groupClass).each(function(index) {
        const color = GROUP_COLORS%[(colorOffset + index) % GROUP_COLORS.length%];
        $(this).data('locked-color', color);
      });
      colorOffset += $('.' + groupClass).length;
    }
    
    $('.' + groupClass).each(function() {
      const color = $(this).data('locked-color');
      const areaId = $(this).attr('id');
      
      $(this).data('maphilight', {
        ...MAPHILIGHT_CONFIG,
        alwaysOn: true,
        fillColor: color,
        fillOpacity: 0.2,
        strokeColor: color,
        groupBy: false
      }).trigger('alwaysOn.maphilight');
      
      $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '#' + color + '66');
    });
  } else {
    $('.' + groupClass).each(function() {
      const areaId = $(this).attr('id');
      $(this).removeData('locked-color');
      $(this).data('maphilight', MAPHILIGHT_CONFIG).trigger('alwaysOn.maphilight');
      $('#' + areaId.replace('area', 'a') + ' span a').css('background-color', '');
    });
  }
});

function loadCurrentImage() {
  displayImage(images_l[current]);
  $("#current").text(current + 1);
  $("#imageCount").text(imagesCount);
}

function loadFirstImage() { current = 0; loadCurrentImage(); }
function loadLastImage() { current = imagesCount - 1; loadCurrentImage(); }
function loadNextImage() { if (current < imagesCount - 1) { current++; loadCurrentImage(); } }
function loadPreviousImage() { if (current > 0) { current--; loadCurrentImage(); } }

$(document).ready(function() {
  $.ajax("%url;&ajax=on")
    .done(function(j) {
      json = j;
      images_l = j.images?.length ? j.images : [{ img: j.img, map: j.map, groups: j.groups }];
      imagesCount = images_l.length;
      if (imagesCount > 1) $("#album-nav").addClass('d-flex');
      document.title = json.title;
      loadCurrentImage();
    })
    .fail(() => $("#h1").text("Erreur de chargement"));
});
</script>
</body>
</html>
