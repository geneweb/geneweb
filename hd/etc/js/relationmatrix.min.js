const RelationMatrix=(()=>{'use strict';const u=new URLSearchParams(window.location.search),b=u.get('b');function gN(i){if(!i)return'N/A';if(window.rmData&&window.rmData.names&&window.rmData.names[i])return window.rmData.names[i];return'iper:'+i}function mPU(i){return'?'+(b?'b='+b+'&':'')+'i='+i}function mEU(i){return'?'+(b?'b='+b+'&':'')+'m=MOD_IND&i='+i}function mRLU(a,l1,p1,l2,p2){const l1s=Array.isArray(l1)?l1.join(','):l1,l2s=Array.isArray(l2)?l2.join(','):l2;return'?'+(b?'b='+b+'&':'')+'m=RL&i='+a+'&l1='+l1s+'&i1='+p1+'&l2='+l2s+'&i2='+p2+'&dag=on'}function gAC(a){const g=[],p=new Set();a.forEach((a1,i1)=>{if(p.has(i1))return;let pt=null,pi=-1;if(a1.f&&a1.f.length>0){for(let i2=i1+1;i2<a.length;i2++){if(p.has(i2))continue;const a2=a[i2];if(a2.f&&a2.f.length>0){const cf=a1.f.some(f1=>a2.f.includes(f1));if(cf){pt=a2;pi=i2;break}}}}p.add(i1);if(pi>=0){p.add(pi);g.push({type:'couple',anc1:a1,anc2:pt})}else{g.push({type:'single',anc:a1})}});return g}function fAG(g,l1,p1,l2,p2){if(g.type==='couple'){const n1=gN(g.anc1.p),u1=mPU(g.anc1.p),r1=mRLU(g.anc1.p,l1,p1,l2,p2),n2=gN(g.anc2.p),u2=mPU(g.anc2.p),r2=mRLU(g.anc2.p,l1,p1,l2,p2);return'<span class="text-nowrap"><a href="'+u1+'">'+n1+'</a> [<a href="'+r1+'">'+g.anc1.c+'</a>]</span> <span class="text-nowrap">&amp; <a href="'+u2+'">'+n2+'</a> [<a href="'+r2+'">'+g.anc2.c+'</a>]</span>'}else{const n=gN(g.anc.p),u=mPU(g.anc.p),r=mRLU(g.anc.p,l1,p1,l2,p2);return'<span class="text-nowrap"><a href="'+u+'">'+n+'</a> [<a href="'+r+'">'+g.anc.c+'</a>]</span>'}}function gSL(sp,p1,p2){const al=new Map();sp.forEach(p=>{if(p.anc&&p.anc.length>0){p.anc.forEach(a=>{if(!al.has(a.p)){al.set(a.p,{name:gN(a.p),levels:[],total:0,partner:null})}const e=al.get(a.p);e.levels.push({l1:p.l1,l2:p.l2,count:a.c});e.total+=a.c})}});const ml=[],pr=new Set();al.forEach((d,i)=>{if(d.levels.length>1&&!pr.has(i)){pr.add(i);al.forEach((d2,i2)=>{if(i2!==i&&d2.levels.length>1&&!pr.has(i2)){const sl=d.levels.every(l1=>d2.levels.some(l2=>l1.l1===l2.l1&&l1.l2===l2.l2));if(sl){d.partner={iper:i2,name:d2.name,total:d2.total};pr.add(i2)}}});ml.push({iper:i,...d})}});if(ml.length===0)return'';let h='<hr class="w-75 my-2"><div class="text-center mx-4">';const en=ml.map(a=>{const l1s=[...new Set(a.levels.map(l=>l.l1))].sort((a,b)=>b-a),l2s=[...new Set(a.levels.map(l=>l.l2))].sort((a,b)=>b-a),u=mRLU(a.iper,l1s,p1,l2s,p2);let r='<span class="text-nowrap"><a href="'+mPU(a.iper)+'">'+a.name+'</a> [<a href="'+u+'">'+a.total+'</a>]</span>';if(a.partner){const pu=mRLU(a.partner.iper,l1s,p1,l2s,p2);r+=' <span class="text-nowrap">&amp; <a href="'+mPU(a.partner.iper)+'">'+a.partner.name+'</a> [<a href="'+pu+'">'+a.partner.total+'</a>]</span>'}return r});h+=en.join(', ')+'</div>';return h}function rAL(cd){let h='';const p1=cd.i1?cd.i1.p:'',p2=cd.i2?cd.i2.p:'',n1=gN(p1),n2=gN(p2),sp=[...cd.data.paths].sort((a,b)=>(b.l1+b.l2)-(a.l1+a.l2));h+='<table class="table table-sm mb-1"><tbody>';sp.forEach(p=>{let ah='';if(p.anc&&p.anc.length>0){const g=gAC(p.anc),fg=g.map(g=>fAG(g,p.l1,p1,p.l2,p2));ah=fg.join(', ')}h+='<tr><td>'+p.l1+'</td><td colspan="2">'+ah+'</td><td>'+p.l2+'</td></tr>'});h+='<tfoot><td><i class="fa-solid fa-person-arrow-up-from-line"></i></td><td class="person"><a href="'+mPU(p1)+'">'+n1+'</a></td><td class="person"><a href="'+mPU(p2)+'">'+n2+'</a></td><td><i class="fa-solid fa-person-arrow-down-to-line fa-flip-horizontal"></i></td></tfoot></tbody></table>';const t=document.getElementById('rm-table');h+='<div class="text-center"><strong><a href="'+cd.url+'" target="_blank">'+cd.data.total+' '+t.dataset.linksLabel+'</a></strong><br><span class="text-muted">'+t.dataset.coeffLabel+' : '+cd.data.coeff+'</span></div>';h+=gSL(sp,p1,p2);return h}function hCC(e){const c=e.target.closest('.rm-cell');e.preventDefault();const d=c.dataset.id;if(!d)return;const u=c.dataset.url,p=d.split('_'),i1=p[0].replace('ยง',''),i2=p[1].replace('ยง',''),cd=Object.values(window.rmData.cells).find(c=>(c.i1.p===i1&&c.i2.p===i2)||(c.i1.p===i2&&c.i2.p===i1));cd.url=u;sRM(cd)}function sRM(d){const m=$('#rmModal'),mb=document.getElementById('rmModalBody');let h='<div class="rm-modal-container">'+rAL(d);if(window.location.search.includes('debug')){h+='<details class="rm-debug"><summary>Debug JSON</summary><pre>'+JSON.stringify(d,null,2)+'</pre></details>'}h+='</div>';mb.innerHTML=h;m.modal('show');setTimeout(()=>{mb.scrollTop=mb.scrollHeight},100)}return{init:function(){if(!window.rmData||!window.rmData.cells){console.error('rmData non disponible');return}const t=document.getElementById('rm-table');if(t){t.addEventListener('click',hCC)}}}})()