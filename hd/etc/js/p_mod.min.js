(function($){'use strict';const MODULES={individu:["standard","centered","two cols"],parents:["simple","simple + photos","evolved","complete","complete + photos"],unions:["simple","simple + photos","evolved","complete","complete + photos"],fratrie:["simple","simple + photos","complete","complete + photos"],relations:["simple","complete"],chronologie:["simple","simple + events"],notes:["simple","complete"],sources:["simple","complete"],arbres:["ascendants","horizontal","compact","descendants"],htrees:["+3-3 gen.","famille","6 gen","8 gen","HI"],gr_parents:["standard","three cols"],ligne:["standard"],data_3col:["standard"],w:["personnel"],x:["personnel"],z:["personnel"]};const MODULE_MAP=new Map();for(const[n,o]of Object.entries(MODULES)){MODULE_MAP.set(n[0],{name:n,opts:o})}const DOM={input:null,builder:null,alert:null,alertMod:null,alertOpt:null,imgPrefix:null,bvar:null,buttons:new Map()};const state={currentValue:'',activeButtons:new Set()};function generateTable(){const r=Object.entries(MODULES).map(([m,o])=>{const b=o.map((t,i)=>{const id=`pm_${m[0]}${i+1}`;DOM.buttons.set(id,{module:m,option:t,index:i});return`<button class="btn btn-outline-primary btn-sm mr-1 text-nowrap"type="button"id="${id}"title="${m} ${t}"data-toggle="popover"data-trigger="hover"data-placement="bottom"data-html="true"data-content="<img src='${DOM.imgPrefix}/${m}_${i+1}.jpg'>">${t}</button>`}).join('');return`<tr><td class="align-middle pmod">${m}</td><td><div class="d-inline-flex">${b}</div></td></tr>`}).join('');return`<table class="table table-sm table-hover mt-2 mb-0"><thead class="thead-default"><tr><th>Module</th><th>Options</th></tr></thead><tbody>${r}</tbody></table>`}function updateButtonStates(){state.activeButtons.forEach(i=>{const b=$(`#${i}`);b.removeClass('btn-primary').addClass('btn-outline-primary')});state.activeButtons.clear();const v=DOM.input.val();for(let i=0;i<v.length-1;i+=2){const m=v.substr(i,2);const b=`pm_${m}`;const e=$(`#${b}`);if(e.length){e.removeClass('btn-outline-primary').addClass('btn-primary');state.activeButtons.add(b)}}}function showError(t,d){DOM.alert.removeClass('d-none');if(t==='module'){DOM.alertMod.removeClass('d-none');DOM.alertOpt.addClass('d-none');$('#alert-module-2').text(d.module)}else{DOM.alertOpt.removeClass('d-none');DOM.alertMod.addClass('d-none');$('#alert-option').text(d.option);$('#alert-module').text(d.module)}const n=DOM.input.val().slice(0,-2);DOM.input.val(n)}function buildView(){const v=DOM.input.val();const i=[];let h=false;for(let x=0;x<=v.length-2;x+=2){const m=v[x];const o=v[x+1];const f=MODULE_MAP.get(m);if(!f){showError('module',{module:m});h=true;break}const d=parseInt(o)-1;if(d<0||d>=f.opts.length){showError('option',{option:o,module:f.name});h=true;break}const s=(m==='z')?'zz_1.jpg':`${f.name}_${o}.jpg`;i.push(`<img class="rm"src="${DOM.imgPrefix}/${s}">`)}if(!h){DOM.builder.html(i.join('\n'));updateButtonStates()}}function addModule(b){const i=DOM.buttons.get(b);if(!i)return;const m=b.slice(3);const p=`${DOM.imgPrefix}/${i.module}_${i.index+1}.jpg`;DOM.input.val(DOM.input.val()+m);DOM.builder.append(`<img class="rm"src="${p}">\n`);$(`#${b}`).removeClass('btn-outline-primary').addClass('btn-primary');state.activeButtons.add(b)}function removeLastModule(){const v=DOM.input.val();if(v.length<2)return;const r=v.slice(-2);const n=v.slice(0,-2);DOM.input.val(n);$('.rm:last-child').remove();if(!n.includes(r)){const b=`pm_${r}`;$(`#${b}`).removeClass('btn-primary').addClass('btn-outline-primary');state.activeButtons.delete(b)}}function clearAll(){DOM.input.val('');DOM.builder.html('');state.activeButtons.forEach(i=>{$(`#${i}`).removeClass('btn-primary').addClass('btn-outline-primary')});state.activeButtons.clear()}function init(){DOM.input=$('#p_mod');DOM.builder=$('#p_mod_builder');DOM.alert=$('.alert');DOM.alertMod=$('.alert-mod');DOM.alertOpt=$('.alert-opt');DOM.imgPrefix=$('.img-prfx').attr('data-prfx');DOM.bvar=$('#p_mod_bvar');$('#p_mod_table').replaceWith(generateTable());$('[data-toggle="popover"]').popover();DOM.alert.alert();setupEventHandlers();if(DOM.input.val()){buildView()}}function setupEventHandlers(){let t;DOM.input.on('input',function(){clearTimeout(t);t=setTimeout(buildView,50)});DOM.alert.on('click',function(){$(this).addClass('d-none');DOM.input.focus()});DOM.bvar.on('click',function(){DOM.input.val($(this).val());buildView()});$('#p_mod_rm').on('click',removeLastModule);$('#p_mod_clear').on('click',clearAll);$('#zz').on('click',function(){DOM.input.val('zz');buildView()});$(document).on('click','[id^="pm_"]',function(e){e.preventDefault();addModule(this.id)})}$(document).ready(init)})(jQuery);