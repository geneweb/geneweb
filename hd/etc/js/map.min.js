import L from"./leaflet.min.js";const NOMINATIM_URL="https://nominatim.openstreetmap.org/search?format=json&limit=1&q=",CACHE_PREFIX="gw_geoloc_",NOMINATIM_DELAY_MS=1100,GEN_COLORS=["#1054a3","#1054a3","#2171b5","#2171b5","#4292c6","#4292c6","#6baed6","#6baed6","#9ecae1","#9ecae1","#c6dbef","#c6dbef"],GEN_COLOR_DEFAULT="#deebf7";function genColor(e){return GEN_COLORS[e-1]||"#deebf7"}function markerRadius(e){return 1===e?5:e<=3?7:e<=6?11:e<=10?14:e<=25?18:e<=50?22:e<=85?30:e<=160?38:44}function nomClean(e){return e.replace(/\s*\(([^)]+)\)/g,", $1").trim()}const viewbox={hits:0,minLat:1/0,maxLat:-1/0,minLon:1/0,maxLon:-1/0,active:!1,update(e,t){this.minLat=Math.min(this.minLat,e),this.maxLat=Math.max(this.maxLat,e),this.minLon=Math.min(this.minLon,t),this.maxLon=Math.max(this.maxLon,t),this.hits++,this.active=this.hits>=5},param(){if(!this.active)return"";const e=.5;return"&viewbox="+(this.minLon-e).toFixed(4)+","+(this.maxLat+e).toFixed(4)+","+(this.maxLon+e).toFixed(4)+","+(this.minLat-e).toFixed(4)}};let lastNomCall=0;async function nomFetch(e){const t=1100-(Date.now()-lastNomCall);t>0&&await new Promise(e=>setTimeout(e,t)),lastNomCall=Date.now();try{const t=NOMINATIM_URL+encodeURIComponent(e)+viewbox.param(),n=await fetch(t),a=await n.json();if(a.length>0){const e=parseFloat(a[0].lat),t=parseFloat(a[0].lon);return viewbox.update(e,t),[e,t]}return null}catch(t){return console.error(`Nominatim: "${e}":`,t),null}}async function geocode(e,t,n){const a="gw_geoloc_"+e,o=localStorage.getItem(a);if(o){const e=JSON.parse(o),n=Array.isArray(e)?e:e&&void 0!==e.c?e.c:e;if(null!==n)return viewbox.update(n[0],n[1]),{coords:n,cached:!0};if(!t)return{coords:null,cached:!0}}let s=null;return s=t&&n?await nomFetch(nomClean(t+", "+n)):await nomFetch(nomClean(e)),localStorage.setItem(a,JSON.stringify(s)),{coords:s,cached:!1}}function buildRLMUrl(e,t,n,a){const o=t.map((e,t)=>`i${t+1}=${e}`).join("&"),s=t.length+1;return`${e}spouse=on;m=RLM;${o}&i${s}=${n}&t${s}=${a}`}function transformToPlaceFormat(e,t){const n={};for(const[a,o]of Object.entries(e.gen)){const s=parseInt(a);for(const[i,r]of Object.entries(o))n[i]||(n[i]={generations:{},coordinates:null,firstAppearance:s,sub:r.sub||null,main:r.main||null}),n[i].generations[a]={eventCount:r.i.length,yearStart:r.s,yearEnd:r.e,individuals:r.i,url:buildRLMUrl(t,r.i,e.meta.index,i)},n[i].firstAppearance=Math.min(n[i].firstAppearance,s)}return{meta:e.meta,places:n}}function genDateRanges(e){const t={};for(const[n,a]of Object.entries(e.gen)){let e=null,o=null;for(const t of Object.values(a))"number"==typeof t.s&&(e=null===e?t.s:Math.min(e,t.s)),"number"==typeof t.e&&(o=null===o?t.e:Math.max(o,t.e));t[n]={min:e,max:o}}return t}function showLoading(e){const t=document.getElementById("loadingPopup"),n=document.getElementById("loadingProgress");t&&(t.style.display="block"),n&&(n.textContent=`0 / ${e}`)}function updateLoading(e,t){const n=document.getElementById("loadingProgress");n&&(n.textContent=`${e} / ${t}`)}function hideLoading(){const e=document.getElementById("loadingPopup");e&&(e.style.display="none")}function showGeoErrors(e,t){if(!e.length&&!t.length)return;const n=document.createElement("div");n.className="geo-error-popup";let a='<div class="geo-error-hd"><span>Géolocalisation</span><button class="close-btn">&times;</button></div>';e.length>0&&(a+='<div style="padding:8px 15px 0"><b>'+e.length+' lieu(x) amalgamé(s) → commune</b></div><ul class="geo-error-list">'+e.map(e=>`<li>${e}</li>`).join("")+"</ul>"),t.length>0&&(a+='<div style="padding:8px 15px 0"><b>'+t.length+' lieu(x) non localisé(s)</b></div><ul class="geo-error-list">'+t.map(e=>`<li>${e}</li>`).join("")+"</ul>"),n.innerHTML=a,document.body.appendChild(n),n.querySelector(".close-btn").addEventListener("click",()=>n.remove())}function mergePlaceInto(e,t,n,a){const o=e[t],s=e[n];for(const[e,t]of Object.entries(o.generations))if(s.generations[e]){const o=s.generations[e],i=[...o.individuals,...t.individuals];o.individuals=i,o.eventCount=i.length,"number"==typeof t.yearStart&&(o.yearStart="number"==typeof o.yearStart?Math.min(o.yearStart,t.yearStart):t.yearStart),"number"==typeof t.yearEnd&&(o.yearEnd="number"==typeof o.yearEnd?Math.max(o.yearEnd,t.yearEnd):t.yearEnd),o.url=buildRLMUrl(a.prefix,i,a.index,n)}else s.generations[e]={...t,url:buildRLMUrl(a.prefix,t.individuals,a.index,n)};s.firstAppearance=Math.min(s.firstAppearance,o.firstAppearance),delete e[t]}async function geocodeAll(e){const t=e.places,n=e.meta,a=Object.entries(t),o=[],s=[];showLoading(a.length);for(let e=0;e<a.length;e++){const[t,n]=a[e],i=await geocode(t,n.sub,n.main);n.coordinates=i.coords,updateLoading(e+1,a.length),null===i.coords&&(n.sub&&n.main?o.push(t):s.push(t))}hideLoading();const i=[];if(o.length>0){const e=new Map;for(const a of o){const o=t[a],r=o.main;let l=null;if(e.has(r))l=e.get(r);else{const n=Object.entries(t).find(([e,t])=>e!==a&&null!==t.coordinates&&(e===r||nomClean(e)===nomClean(r)));if(n)l=n[1].coordinates;else{l=(await geocode(r,null,null)).coords}e.set(r,l)}if(l){let e=null;for(const[n,o]of Object.entries(t))if(n!==a&&null!==o.coordinates&&(n===r||nomClean(n)===nomClean(r))){e=n;break}e?mergePlaceInto(t,a,e,n):(t[r]={generations:{},coordinates:l,firstAppearance:o.firstAppearance,sub:null,main:null},mergePlaceInto(t,a,r,n)),i.push(a)}else s.push(a)}}showGeoErrors(i,s)}class GenNav{constructor(e,t,n,a){this.L=e,this.data=t,this.raw=n,this.map=a,this.gen=t.meta.maxGen,this.markers=new Map,this.playing=!1,this.speed=3,this.timer=null,this.dateRanges=genDateRanges(n),this._bindControls(),this.showGen(this.gen)}_bindControls(){const e=document.getElementById("generationSlider");e&&e.addEventListener("input",e=>{this.showGen(parseInt(e.target.value))});const t=document.getElementById("playButton");t&&t.addEventListener("click",()=>this._toggle());const n=document.getElementById("speedSlider"),a=document.getElementById("speedValue");n&&a&&n.addEventListener("input",e=>{this.speed=parseFloat(e.target.value),a.textContent=`${this.speed}×`,this.playing&&(this._stop(),this._play())})}showGen(e){this.gen=e;const t=this._collect(e);this._renderMarkers(t),this._updateUI(e,t)}_collect(e){const t=[];for(const[n,a]of Object.entries(this.data.places)){let o=0,s=null,i=null,r=null;for(let t=0;t<=e;t++){const e=a.generations[t];e&&(o+=e.eventCount,s=null===s?e.yearStart:Math.min(s,e.yearStart),i=null===i?e.yearEnd:Math.max(i,e.yearEnd),r=e.url)}o>0&&a.coordinates&&t.push({name:n,coordinates:a.coordinates,eventCount:o,yearStart:s,yearEnd:i,firstAppearance:a.firstAppearance,url:r})}return t}_renderMarkers(e){this.markers.forEach(e=>this.map.removeLayer(e)),this.markers.clear();for(const t of e){const e=new this.L.CircleMarker(t.coordinates,{radius:markerRadius(t.eventCount),fillColor:genColor(t.firstAppearance),color:"#333",weight:2,fillOpacity:.7,className:"generation-marker"}),n=t.yearStart===t.yearEnd?t.yearStart:`${t.yearStart}–${t.yearEnd}`;e.bindPopup(`<strong class="d-flex align-self-center text-center">${t.name}</strong><div class="d-flex mt-1"><div class="flex-grow-1">${n}<br>${t.eventCount} événement`+(t.eventCount>1?"s":"")+'<div class="legend-item text-muted small mt-1">'+`<span>&gt; ${t.firstAppearance}e gén.</span> <div class="legend-color mb-1" style="background-color:`+genColor(t.firstAppearance)+'"></div></div></div>'+`<a role="button" href="${t.url}" target="_blank" class="btn btn-sm mt-1 ml-auto"><i class="fa fa-user fa-fw mr-1"></i>Arbre</a></div>`),this.markers.set(t.name,e),e.addTo(this.map)}}_updateUI(e,t){const n=document.querySelector(".current-generation");n&&(n.textContent=`Gén. ${e}`);const a=document.getElementById("generationSlider");a&&(a.value=e);const o=document.getElementById("placesCount");o&&(o.textContent=t.length);const s=document.getElementById("eventsCount");s&&(s.textContent=t.reduce((e,t)=>e+t.eventCount,0));const i=document.getElementById("timelineText");if(i)if(0===e)i.textContent=this.data.meta.person+" • Génération actuelle";else{const t=this.dateRanges[e];if(t&&null!==t.min){const n=t.min===t.max?t.min:`${t.min}–${t.max}`;i.textContent=`Génération ${e} • ${n}`}}}_toggle(){this.playing?this._stop():this._play()}_play(){this.playing=!0,this.showGen(0);const e=document.getElementById("playButton");if(e){e.classList.add("playing");const t=e.querySelector(".play-icon"),n=e.querySelector(".play-text");t&&(t.textContent="⏸"),n&&(n.textContent="Pause")}this.timer=setInterval(()=>{this.gen<this.data.meta.maxGen?this.showGen(this.gen+1):this._stop()},2e3/this.speed)}_stop(){this.playing=!1;const e=document.getElementById("playButton");if(e){e.classList.remove("playing");const t=e.querySelector(".play-icon"),n=e.querySelector(".play-text");t&&(t.textContent="▶"),n&&(n.textContent="Lire")}this.timer&&(clearInterval(this.timer),this.timer=null)}}async function initMap(e){const t=transformToPlaceFormat(e,e.meta.prefix);await geocodeAll(t);const n=new L.Map("map"),a=Object.values(t.places).map(e=>e.coordinates).filter(e=>null!==e);if(a.length>1){const e=new L.LatLngBounds(a);n.fitBounds(e,{padding:[40,40]})}else 1===a.length?n.setView(a[0],12):n.setView([46.5,2.5],6);new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(n),new GenNav(L,t,e,n)}document.addEventListener("DOMContentLoaded",()=>{const e=window.__mapData;e&&initMap(e)});