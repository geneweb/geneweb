<!DOCTYPE html>
<html lang="%lang;">
<head>
  <!-- $Id: cousmenu.txt, v7.1 12/12/2022 10:44:01 ddr a2 Exp $ -->
  <!-- Copyright (c) 1998-2023 INRIA -->
  <title>%nn;
    [*relationship link between]%sp;
    %if;(public_name != "")%public_name;%else;%first_name;%end;
    %if;(qualifier != "") %qualifier;%end;
    %sp;%surname;
  </title>
  <meta name="robots" content="none">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  %include;favicon
  %include;css
  %include;hed
</head>
%(TODO :
* highlight/filter by nbr
* RLM par chemin vers les mêmes ancêtres / need to fix RLM spouses isolated)
* discuter quoi afficher comme « comptage des chemins »
* highlight sur les cases avec des individus vivants + counts
%)
<body%body_prop;>
%message_to_wizard;
<div class="container%if;(e.v!="" and e.v>6)-fluid%end;">
<div class="d-flex flex-column justify-content-center">
%include;perso_utils
%include;menubar
%let;min;%if;(not has_children)1%else;0%end;%in;
%let;max;%if;(bvar.max_anc_level!="" and bvar.max_anc_level<max_anc_level)%bvar.max_anc_level;%elseif;(static_max_anc_level!="")%static_max_anc_level;%end;%in;
%define;picklvl(vvv)
  <a role="button" class="btn btn-sm btn-light %if;(e.v!="" and e.v=vvv) disabled font-weight-bold text-white bg-dark%else; %end; p-1%if;(vvv<10) px-2%end;" href="%url_set.v.vvv;"%sp;
  title="[*ascending/descending (degree)]0 vvv%if;(vvv=0)[:] [person/persons]0 [and] [descendants]%end;">vvv</a>%nn;
%end;
<div class="d-flex flex-column align-self-center order-1">
  <div class="btn-group py-0" role="group" aria-label="buttons to select max ascending level v">
    <div class="py-0 btn-group d-flex flex-wrap" role="group" aria-label="button v from 0 to max">
      %for;i;min;max;%apply;picklvl(i)%end;
    </div>
  </div>
</div>
%define;cousin_lex_tt(vvv,www)
  %( condition pour garder la tooltip (title="") vide si elle n'est pas définie pour la langue en cours %)
  %if;([cousins.vvv.www tt]!="[cousins.vvv.www tt]")[cousins.vvv.www tt]1%else;%end;
%end;
%define;cousin_lex(vvv,www)
  [cousins.vvv.www]1
%end;
%define;index(ppp,vvv,xxx)
  %ppp_of_index.vvv.xxx;
%end;
%define;cous_paths(vvv,www)
  %cous_paths.vvv.www;
%end;
%define;cous_paths_cnt(vvv,www)
  %cous_paths_cnt.vvv.www;
%end;
%define;cousins_cnt(vvv,www)
  %cousins_cnt.vvv.www;
%end;
%empty_sorted_list;%empty_sorted_listb;%empty_sorted_listc;
%define;cous_mod(vvv,www)
  %empty_sorted_list;%empty_sorted_listb;
  %foreach;cous_path;
    %let;cous_isdead;%apply;index("p",cousin.index,"is_dead")%in;
    %let;cous_nodesc;%apply;index("p",cousin.index,"has_children")%in;
    %apply;add_in_sorted_list%with;%cousin.surname; %cousin.first_name %cousin.dates; %cousin.occ;%and;%nn;
      <li class="card list-group-item text-small nbr_%cousin.nbr; py-1 px-1 rounded border-top-0 border-bottom-0 border-%if;(cousin.sex=0)primary%elseif;(cousin.sex=1)danger%else;dark%end;"%if;(cous_isdead=0) data-alive="%cous_isdead;"%end; style="border-left-width:%if;(cous_isdead=1)5px;background-color:linen;%else;10px;%end;%if;(cous_nodesc!=1)border-style:double;%end;"
      data-birthdate='%cousin.index;'>%nn;
        <div class="d-flex align-content-between align-items-start">
          <div class="d-block flex-grow-1 align-self-center ml-1
            text-truncate text-left text-nowrap position-relative" style="line-height:1.5rem;">
            <a href="%prefix;em=R&et=A&ei=%self.index;&i=%cousin.index;"
              data-toggle="tooltip" data-html="true" class="stretched-link w-auto%if;(cous_isdead=1) ml-1%end;"
              title="%cousin.first_name;.%cousin.occ; %cousin.surname;
              %(%cousin.dates; bug w. balise <bdo> in dates %) (%cousin.anc_f_list;)"
              data-anclist="%cousin.anc_f_list;">
              %cousin.surname; %cousin.first_name %cousin.dates;</a>
          </div>
          %if;(www!=0)
            <div class="ml-auto align-self-center position-relative" style="z-index:1">
              <a class="btn px-1 mx-0" data-toggle="tooltip" data-html="true"
                href="%prefix;m=RL&i=%if;(vvv=0)%self.index;%else;%cousin.anc1.index;%end;&l1=vvv&i1=%self.index;&l2=www&i2=%cousin.index;%nn;
                %if;(cousin.nbr>1)&dag=on%end;"%sp;
                title="%apply;a_of_b%with;%if;(cousin.sex=0)[cousin.0.www]0%else;[cousin.0.www]1%end;%and;%cousin.anc1.first_name; %cousin.anc1.surname;%(%apply;index("p",cousin.anc1.index,"sosa.v") not working%)
                %if;(cousin.anc2!=".....") [and] %cousin.anc2;%end;%end;">
                %if;(cousin.nbr %2 = 0)<i class="fa-solid fa-user-group"></i>%else;<i class="fa-solid fa-user fa-fw text-%if;(cousin.anc2!=".....")info%else;%if;(cousin.anc1.sex=0)primary%elseif;(cousin.sex=1)danger%else;muted%end;%end;"></i>%end;%nn;
                %if;(cousin.nbr>2)<span class="small"><sup>%cousin.nbr;</sup></span>%end;</a>
            </div>
          %end;
        </div>
     </li>%and;%cousin.cnt;%and;%cousin.index;%end;
    %apply;add_in_sorted_listb%with;%cousin.index;%and;%cous_isdead;%and;%cous_nodesc;%end;
    %apply;add_in_sorted_listc%with;%cousin.index;%and;%cous_isdead;%and;%cous_nodesc;%end;
  %end;
  %reset_count;%reset_count2;
  %foreach;sorted_listb_item;
    %if;(item.2=0)%incr_count;%end;
    %if;(item.3=0)%incr_count2;%end;
  %end;
  <div class="modal fade px-2" id="modal_vvv_www" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" style="overflow-y:scroll;">%(tofix : quick hack to allow scrolling on next modal and not body after dismissing a first modal%)
    <div class="modal-dialog modal-xl%( modal-dialog-centered%)" style="width:98%%;max-width:1400px;
      %(%if;(listb_size>127)1600%elseif;(listb_size>31)1200%elseif;(listb_size>9)992%else;600%end;px;%)">
      <div class="modal-content bg-transparent border-0">
        <div class="%(modal-header %)position-relative p-2 pb-1 rounded-lg%if;(count!=0) bg-white"%else;" style="background-color:linen"%end;>
          %let;extrapaths;%expr(cous_paths_cnt.vvv.www-listb_size)%in;
          <div class="modal-title bg-transparent">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-inline-flex col-auto flex-column align-self-center text-left ml-3">
                <div>%listb_size %if;(cousins_cnt.vvv.www=1)[person/persons]0%else;[person/persons]1%end;
                %if;(count!=0)
                  <div>
                    %if;(2*count<cousins_cnt.vvv.www)%count; [alive]3
                    %else;%expr(cousins_cnt.vvv.www-count) [died]3 <span style="background-color:linen">  </span>
                    %end;
                  </div>
                %end;
                </div>
                %if;(count2>0)
                  <div>%count2; [no descendants] ║</div>
                %end;
              </div>
              <div class="d-flex justify-content-center text-center align-items-center">
                <a role="button" class="h2 display-4 stretched-link ml-2"
                  style="font-size:2rem;font-weight:300;" data-toggle="tooltip" data-html="true" 
                  href="%prefix;m=RLM%foreach;sorted_list_item;&i1=%self.index;&i%expr(item.3+1)=%item.4;%end;&t1=[cousins.vvv.www]" class="btn btn-primary" title="Graphe RLM c(vvv,www)">%nn;
                  %if;(vvv+www=0)
                    %if;(sex=1)[him/her]0%else;[him*her]1%end;
                  %else;
                   %if;(cousins_cnt.vvv.www=1)[cousins.vvv.www]0%else;[cousins.vvv.www]1%end;%nn;
                   %end;
                </a>%nn;
                <small class="text-muted">%if;(extrapaths!=0) (+ %extrapaths;)%end;</small>
              </div>
              %(<div class="flex-grow-1 bg-transparent"> </div>%)
              %let;cousdown;%apply;cousins_cnt%with;vvv%and;%expr(www+1)%end;%in;
              <div class="d-flex col-auto justify-content-end align-items-end ml-2" style="z-index:1">
                <div class="d-inline-flex align-self-center">
                  <div class="d-flex align-items-end">
                    %if;(vvv>0 and www=0)
                      <button type="button" class="btn btn-sm py-0 mb-1 btn-light" data-dismiss="modal" data-toggle="modal" data-target="#modal_%expr(vvv-1)_www" ><i class="fa-solid fa-arrow-down-long fa-fw fa-rotate-by" style="--fa-rotate-angle: 45deg;" title="%expr(vvv-1)/0" ancestors at g-1" data-toggle="tooltip"></i></button>
                    %end;
                  </div>
                  <div class="d-inline-flex flex-column ml-2">
                    <div>
                      <button type="button" class="btn btn-sm py-0 mt-2 btn-light%if;(vvv=e.v and www=0) disabled%end;" data-dismiss="modal" data-toggle="modal" data-target="#modal_%if;(www=0)%expr(vvv+1)_0%else;vvv_%expr(www-1)%end;"><span title="%if(www=0)%expr(vvv+1)/0%else;vvv/%expr(www-1)%end;" data-toggle="tooltip" data-html="true"><i class="fa-solid fa-arrow-up-%if;(www=0)right-dots%else;long%end; fa-fw"></i>vvv</span></button>
                    </div>
                    <div>
                      <button type="button" class="btn btn-sm py-0 mt-1 btn-light%if;(cousdown=0) disabled%end;" data-dismiss="modal" data-toggle="modal" data-target="#modal_vvv_%expr(www+1)"><span title="vvv/%expr(www+1)" data-toggle="tooltip" data-html="true"><i class="fa-solid fa-arrow-down-long fa-fw"></i>www</span></button>
                    </div>
                  </div>
                  <a role="button" href="%prefix;%access;&m=C&v1=vvv&v2=www" 
                    class="btn btn-lg btn-light mx-1 my-2">
                      <span data-toggle="tooltip" data-html="true" title="voir tous les [relationship link/relationship links]1, %expr(vvv+www) [degree]?">
                        <i class="fa-solid fa-person-arrow-up-from-line"></i>
                        <i class="fa-solid fa-person-arrow-down-to-line fa-fw fa-flip-horizontal"></i>
                      </span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-body">
          <div class="card-columns"%( style="column-count:
            %if;(cous_paths_cnt.vvv.www>511)5%nn;
            %elseif;(cous_paths_cnt.vvv.www>127)4%nn;
            %elseif;(cous_paths_cnt.vvv.www>31)3
            %elseif;(cous_paths_cnt.vvv.www>9)2%else;1%end;"%)>
            <ul class="list-group bg-transparent" class="listitems">
              %foreach;sorted_list_item;%item.2;%end;
            </ul>
          </div>
        </div>
      %(<div class="modal-footer">
          %( TODO extraire les nbr des filtres js par nbr %)
            %for;i;0;nbr;<a role="button" class="btn btn-light" title="filter by nbr = i">i</a>%end;
        </div>%)
      </div>
    </div>
  </div>
%end;
%( TODO : si cousin est sosa de la racine ajouter l'icone sosa verte devant le nom ?? %)
%define;link_cousin(vvv,www)
  %let;extra_paths_vvv_www;%expr(cous_paths_cnt.vvv.www - cousins_cnt.vvv.www)%in;
  %let;width;%expr((100/(e.v+1))*vvv)%in;
  %let;percent_vvv_www;%expr(100-count*100/cousins_cnt.vvv.www)%in;
  <button type="button" data-toggle="tooltip" data-html="true" 
    class="p-1 mx-1 btn-light position-relative%if;(vvv+www=0) disabled%end; %if;(percent_vvv_www=0)border-0%end;"
    style="height:5rem;%if;(percent_vvv_www=100)background-color: rgba(245,231,216,0.9);%end;"
    title="%(<span class='h5 pt-2 px-2'>%apply;cousin_lex(i,k)</span><hr class='bg-light text-white my-2 mx-4'>%)
    <div class='d-flex justify-content-center mt-1'>
      <div class='mr-4 h5'>
        <i class='fa-solid fa-arrow-up-right-dots fa-fw'></i>
        <span class='font-weight-heavy'>vvv</span>
        <i class='fa-solid fa-arrow-down-long'></i>
        <span class='font-weight-heavy ml-1'>www</span>
      </div>
      <div class='ml-4 h5'>
        <i class='fa-solid fa-dna fa-fw'></i>
        %if;(vvv=0 or www=0)%expr((100/.(2^(vvv+www))))%else;%expr((100/.(2^(vvv+www-1))))%end; %%
      </div>
    </div><hr class='bg-light text-white mt-0 mb-1'>%apply;cousin_lex_tt(i,k)">
    <div class="d-flex justify-content-around stretched-link h-100"
      data-toggle="modal" data-target="#modal_vvv_www"%if;(percent_vvv_www!=0 and percent_vvv_www!=100) 
style="background: linear-gradient(270deg, rgba(245,231,216,0.9) %if;(percent_vvv_www>1)%expr(percent_vvv_www-1)%else;1%end;%%, rgba(248,249,250,0) %if;(percent_vvv_www<99)%expr(percent_vvv_www+1)%else;100%end;%%"%end;>
      <div class="order-2 w-75 align-self-center text-bottom">
        %if;(i=0 and k=0)%if;is_male;[him/her]0%elseif;is_female;[him/her]1%end;%else;%apply;cousin_lex(i,k)%end;
      </div>
      <div class="d-flex justify-content-end align-self-center text-right">
        <div class="h5 mt-2 py-0 pr-0
          text-%if;(vvv=0)info%elseif;(vvv%2=1)primary%else;danger%end;">%cousins_cnt.vvv.www;
          </div>
          %(%if;(extra_paths_vvv_www!=0)*
            %(<div class="badge badge-xl badge-info">%extra_paths_vvv_www;</div>%)
          %end;%)
      </div>
    </div>
  </button>
%end;
%( table of cousins.j-vvv+i.i c(k,i) | table size = v × (v+%cousins.max_d;)
    == l1 asc./l2 = max_desc (plus longue colonne v2) %)
%define;table(xxx)
  %let;maxdesc;%expr(cousins.max_d+xxx)%in;
  <table id="quickrel" class="table table-responsive-sm mb-0 mt-1 order-3">
    %for;j;1;maxdesc;
      <tr style="height:2rem">%nn;
        %(<td class="h3 align-center border-0 mr-1">
          %if;(j>0 and j<=e.v)%expr(e.v+1-j)%else; %end;</td>%)
        %for;i;0;xxx;
          %let;k;%expr(j+i-xxx)%in;
          %if;(k>=0)
              %let;tot;%apply;cous_paths_cnt%with;%i;%and;%k;%end;%in;
              %let;tot_next;%apply;cous_paths_cnt%with;%i;%and;%expr(k+1)%end;%in;
              %if;(i>1 and k=0)
                <td colspan="%expr(i-1)" class="border-0"> </td>
              %end;
              <td%if;(j=xxx) width="%expr(100/xxx)%%"%end;%if;(i>0 and k=0) colspan="2"%end;%sp;
                class="border-0 border-top-0 border-bottom-0 border-right-0">
                %if;(tot!=0)
                  <div class="d-flex flex-column justify-content-center border-0 py-0">
                    %apply;cous_paths(i,k)
                    %apply;cous_mod(i,k)
                    %apply;link_cousin(i,k)
                    <div class="d-inline-flex py-0">
                      %if;(i!=0 and k=0)
                      %( for ancestors c(i,0) border links | self has 2×col-6 and his ancestors 4×col-3
            prints — only first cell border if c(i-1,0) have no siblings [cousins_cnt.i.1=0] |
                   — two first even cells borders overwise | |
                   — nothing if self has no children %)
                        %let;mx;%if;(i=0)1%else;3%end;%in;
                        %for;z;0;mx;
                          %let;couscntk1;%apply;cousins_cnt%with;%i%and;1%end;%in;
                         <div style="height:15px" class="col-%if;(i=0)6%else;3%end;
                           %if;(((couscntk1=0 and z=0) or (couscntk1!=0 and z%2=0))
                             and not (i=0 and not has_children)) border-dark border-right%end;"> </div>
                        %end;
                      %else;
                        %if;(j<max-1)
                          <div class="col-6 border-dark%if;(tot_next!=0) border-right
                          border-top-0 border-left-0 border-bottom-0%else; border-0%end;" style="height:15px"> </div>
                          <div class="col-6 border-0"> </div>
                        %end;
                      %end;
                    </div>
                  </div>
                %end;
              </td>
          %end;
        %end;
        %(<td class="h3 align-top border-0">%if;(j>1)%expr(j-1)%else; %end;</td>%)
      </tr>
    %end;
    <tr>
      <td class="border-0" colspan="%expr(xxx+1)">
        <div class="d-flex flex-column justify-items-center mt-2">
          <span><i class="fa-solid fa-dna fa-sm mr-1"></i>[coefficient of relationship]</span>
          <span><i class="fa-solid fa-user fa-sm mr-1"></i>[one ancestor counted]</span>
          <span><i class="fa-solid fa-warning fa-sm text-danger mr-1"></i>[multiple relations]</span>
        </div>
      </td>
    </tr>
  </table>
%end;
%if;(e.v="")
  %apply;table(6)
%else;
  %apply;table(e.v+1)
%end;
%( page title + counts shown at top of page using flex order %)
  <div class="d-flex justify-content-between order-2 mt-1">%nn;
    <h3 class="h4">[*link between]
      %if;(public_name != "")%public_name;%else;%first_name;%end;
      %if;(qualifier != "") <em>%qualifier;</em>%end;
      %sp;%surname;
      %(%if;(alias != "") <em>(%alias;)</em>%end;%)
      %sp;[and] [close family] [up to] %e.v; [generation/generations]1%( montantes [and] %expr(e.v+cousins.max_d) descendantes…%)
    </h3>
    <div class="d-flex flex-column justify-content-end text-right">
      %( quick count ascendants | TODO : filter by index to reduce asc./desc. implexes %)
      %reset_count;
      %if;has_parents;
        %for;i;0;e.v;
          %let;tt;%apply;cousins_cnt%with;%expr(i+1)%and;0%end;%in;
          %for;j;0;tt;%incr_count;%end;
        %end;
      %end;
      <span class="text-muted" title="Ancestor/Descendant/Persons/Living">%count;A%nn;
      %reset_count;
      %if;has_children;
        %for;i;1;cousins.max_d;
          %let;tt;%apply;cousins_cnt%with;0%and;%i%end;%in;
          %for;j;0;tt;%incr_count;%end;
        %end;
      %end;
      /%count;D
      %reset_count;%foreach;sorted_listc_item;%if;(item.2=0)%incr_count;%end;%end;%nn;
      %listc_size;P/%count;L</span>
    </div>
  </div>
</div>
%include;trl
%include;copyr
</div>
%include;js
<script>
$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})
$(function () {
  $('[data-toggle="popover"]').popover()
})
%($('#modal_'+v+'_'+w).on('shown.bs.modal', function() {
  $(".listitems li").sort(sort_li).appendTo('.listitems');
  function sort_li(a, b) {
    return ($(b).data('birthdate')) < ($(a).data('birthdate')) ? 1 : -1;
  }
});
$("#sortbtn").on("click", function() {
  $(".listitems li").sort(sort_li).appendTo('.listitems');
  function sort_li(a, b) {
    return ($(b).data('birthdate')) < ($(a).data('birthdate')) ? 1 : -1;
  }
});%)
</script>
</body>
</html>
